<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Warenwirtschaft - Casa Divani</title>

<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<!-- PDF Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
:root {
  --primary-color: #4CAF50;
  --secondary-color: #2196F3;
  --accent-color: #FFC107;
  --delete-color: #F44336;
  --text-color: #333;
  --bg-color: #f4f6f8;
  --card-bg: #fff;
  --shadow: 0 4px 12px rgba(0,0,0,0.1);
  --border-radius: 8px;
  --transition: all 0.3s ease;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Roboto', sans-serif; background: var(--bg-color); color: var(--text-color); line-height: 1.5; font-size: 13px; }

h1 {
  margin-bottom: 20px;
  color: #222;
  font-size: 32px;
  font-weight: 500;
  position: relative;
  padding-right: 100px;
  line-height: 80px;
}
h1 img {
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  height: 80px;
  border-radius: 50%;
  box-shadow: var(--shadow);
}

h2 { margin-top: 30px; margin-bottom: 10px; color: #222; font-weight: 500; }
.container { width: 95%; max-width: 1600px; margin: auto; padding: 20px; }
.section { background: var(--card-bg); padding: 24px; margin-bottom: 24px; border-radius: var(--border-radius); box-shadow: var(--shadow); overflow-x: auto; transition: var(--transition); min-width: 0; }
.section:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.12); }

input, select, button { padding: 10px; margin: 6px 0; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; transition: var(--transition); }
input:focus, select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(76,175,80,0.15); }
button { background-color: var(--primary-color); color: #fff; border: none; cursor: pointer; font-weight: 500; }
button:hover { background-color: #45a049; transform: translateY(-1px); }

table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 12px; table-layout: fixed; }
th, td { border: 1px solid #e0e0e0; padding: 8px 6px; text-align: left; overflow: hidden; text-overflow: ellipsis; font-size: 12px; }
th { background-color: #f8f9fa; font-weight: 500; }

/* Spaltenbreiten Lager */
#lagerTabelle th:nth-child(1), #lagerTabelle td:nth-child(1) { width: 8%; }
#lagerTabelle th:nth-child(2), #lagerTabelle td:nth-child(2) { width: 12%; }
#lagerTabelle th:nth-child(3), #lagerTabelle td:nth-child(3) { width: 12%; }
#lagerTabelle th:nth-child(4), #lagerTabelle td:nth-child(4) { width: 8%; }
#lagerTabelle th:nth-child(5), #lagerTabelle td:nth-child(5) { width: 8%; }
#lagerTabelle th:nth-child(6), #lagerTabelle td:nth-child(6) { width: 6%; }
#lagerTabelle th:nth-child(7), #lagerTabelle td:nth-child(7) { width: 7%; }
#lagerTabelle th:nth-child(8), #lagerTabelle td:nth-child(8) { width: 7%; }
#lagerTabelle th:nth-child(9), #lagerTabelle td:nth-child(9) { width: 7%; }
#lagerTabelle th:nth-child(10), #lagerTabelle td:nth-child(10) { width: 5%; }
#lagerTabelle th:nth-child(11), #lagerTabelle td:nth-child(11) { width: 6%; }
#lagerTabelle th:nth-child(12), #lagerTabelle td:nth-child(12) { width: 7%; }
#lagerTabelle th:nth-child(13), #lagerTabelle td:nth-child(13) { width: 10%; }
#lagerTabelle th:nth-child(14), #lagerTabelle td:nth-child(14) { width: 7%; }

tr:nth-child(even) { background-color: #fafafa; }
tr:hover { background-color: #f1f1f1; }
tr.complete { background-color: #e8f5e9; }

.btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; transition: var(--transition); font-size: 12px; }
.btn-edit { background-color: var(--accent-color); color: white; } .btn-edit:hover { background-color: #e0a800; }
.btn-delete { background-color: var(--delete-color); color: white; } .btn-delete:hover { background-color: #d32f2f; }
.btn-verkaufen { background-color: var(--secondary-color); color: white; } .btn-verkaufen:hover { background-color: #0b7dda; }
.btn-pdf { background-color: #607D8B; color: white; margin-right: 5px; } .btn-pdf:hover { background-color: #455A64; }
.btn-add { background-color: var(--primary-color); color: white; font-size: 16px; padding: 12px 24px; margin-bottom: 16px; }

.search-input { margin-bottom: 12px; width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd; }
.tab { display: inline-block; padding: 12px 24px; background: #e0e0e0; cursor: pointer; border-radius: 6px 6px 0 0; margin-right: 6px; font-weight: 500; transition: var(--transition); }
.tab.active { background: var(--primary-color); color: white; }
.tab:hover { background: #d0d0d0; }

.tab-content { display: none; }
.tab-content.active { display: block; }

.modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.55); align-items: center; justify-content: center; }
.modal-content { background: var(--card-bg); margin: auto; padding: 32px; width: 600px; max-width: 95%; border-radius: 12px; box-shadow: var(--shadow); position: relative; }
.modal-content h2 { margin-bottom: 24px; font-size: 24px; color: #222; font-weight: 500; }
.modal-content label { display: block; font-size: 14px; font-weight: 500; color: #555; margin: 12px 0 4px; }
.modal-content input, .modal-content select { width: 100%; }
.close { position: absolute; right: 24px; top: 20px; font-size: 28px; cursor: pointer; color: #999; transition: var(--transition); }
.close:hover { color: #000; }

@media (max-width: 1200px) { 
  body { font-size: 12px; }
  th, td { padding: 6px 4px; font-size: 11px; }
  .btn { padding: 4px 8px; font-size: 11px; }
}
@media (max-width: 992px) {
  .section { overflow-x: auto; }
}
</style>
</head>
<body>

<!-- LOGIN MODAL -->
<div id="loginModal" class="modal" style="display: flex; z-index:9999;">
  <div class="modal-content">
    <h2>Login</h2>
    <input type="text" id="loginUser" placeholder="Benutzername">
    <input type="password" id="loginPass" placeholder="Passwort">
    <button onclick="checkLogin()">Anmelden</button>
    <p id="loginError" style="color:red;margin-top:10px;"></p>
  </div>
</div>

<div class="container">
  <h1>Warenwirtschaft - Casa Divani
    <img src="https://i.imgur.com/o8Lowx7.png" alt="Casa Divani Logo">
  </h1>

<div>
  <div class="tab active" onclick="switchTab('artikelTab')">Artikelverwaltung</div>
  <div class="tab" onclick="switchTab('verkaufTab')">Kaufvertrag</div>
  <div class="tab" onclick="switchTab('archivTab')">Archiv</div>
  <div class="tab" onclick="switchTab('steuerTab')">Steuerbericht</div>
  <div class="tab" onclick="switchTab('umsatzTab')">Umsatzübersicht</div>
  <div class="tab" onclick="switchTab('forderungenTab')">Forderungen/Verbindlichkeiten</div>
</div>

<!-- Artikelverwaltung -->
<div id="artikelTab" class="tab-content active section">
  <h2>Artikel erfassen / Lager</h2>
  <button class="btn btn-add" onclick="openArtikelAddModal()">+ Artikel hinzufügen</button>

  <input type="text" class="search-input" id="lagerSuche" placeholder="Suche Lager..." onkeyup="filterLager()">
  <table id="lagerTabelle">
    <tr><th>Nr.</th><th>Name</th><th>Beschreibung</th><th>AuftragsNr.</th><th>Wareneingang</th><th>Herkunft</th><th>EK brutto</th><th>VK brutto</th><th>Marge Faktor</th><th>Menge</th><th>Steuer %</th><th>In Ausstellung</th><th>Aktionen</th><th>Bezahlt</th></tr>
  </table>
</div>

<!-- Kaufvertrag -->
<div id="verkaufTab" class="tab-content section">
  <h2>Kaufvertrag / Verkauf</h2>
  <input type="text" class="search-input" id="verkaufSuche" placeholder="Suche Artikel..." onkeyup="updateVerkaufTabelle()">
  <table id="verkaufTabelle">
    <tr><th>Artikelname</th><th>Artikelnummer</th><th>Beschreibung</th><th>VK brutto</th><th>Menge</th><th>MwSt €</th><th>Aktion</th></tr>
  </table>

  <h3>Aktuelle Kaufvertragsartikel:</h3>
  <table id="aktuelleKaufvertragTabelle">
    <tr><th>Artikelname</th><th>Artikelnummer</th><th>Beschreibung</th><th>Menge</th><th>VK brutto</th><th>MwSt €</th><th>Aktion</th></tr>
  </table>

  <button onclick="openKundeModal()">Kundendaten erfassen & Kaufvertrag abschließen</button>
</div>

<!-- Archiv -->
<div id="archivTab" class="tab-content section">
  <h2>Archivierte Kaufverträge</h2>
  <input type="text" class="search-input" id="archivSuche" placeholder="Suche Archiv..." onkeyup="updateArchivTabelle()">
  <table id="archivTabelle">
    <tr><th>Kaufvertragsnummer</th><th>Kunde</th><th>Datum</th><th>Gesamtbetrag</th><th>Anzahlung</th><th>Restbetrag</th><th>Auftragsbestätigungsnummer</th><th>Ausgeliefert</th><th>Abgerechnet</th><th>Herstellerverbindlichkeiten bezahlt</th><th>Aktionen</th></tr>
  </table>
</div>

<!-- Steuerbericht -->
<div id="steuerTab" class="tab-content section">
  <h2>Steuerbericht</h2>
  <table id="steuerTabelle">
    <tr><th>Kaufvertragsnummer</th><th>Artikel</th><th>Menge</th><th>VK brutto</th><th>EK brutto</th><th>Umsatzsteuer €</th><th>Vorsteuer €</th><th>Steuerlast €</th></tr>
  </table>
  <p id="steuerSumme" style="margin-top:10px;font-weight:bold;"></p>
  <button onclick="downloadSteuerPDF()">PDF Steuerbericht</button>
</div>

<!-- Umsatzübersicht -->
<div id="umsatzTab" class="tab-content section">
  <h2>Umsatzübersicht</h2>
  <table id="umsatzTabelle">
    <tr><th>Kaufvertragsnummer</th><th>Artikel</th><th>VK brutto €</th><th>EK brutto €</th><th>Reingewinn €</th></tr>
  </table>
  <p id="umsatzSumme" style="margin-top:10px;font-weight:bold;"></p>
</div>

<!-- Forderungen/Verbindlichkeiten -->
<div id="forderungenTab" class="tab-content section">
  <h2>Forderungen/Verbindlichkeiten</h2>
  <h3>Offene Forderungen</h3>
  <table id="forderungenTabelle">
    <tr><th>Kaufvertragsnummer</th><th>Kunde</th><th>Restbetrag €</th><th>Bezahlt</th><th>Aktionen</th></tr>
  </table>
  <p id="forderungenSumme" style="margin-top:10px;font-weight:bold;"></p>

  <h3>Offene Verbindlichkeiten</h3>
  <table id="verbindlichkeitenTabelle">
    <tr><th>Kaufvertragsnummer</th><th>Artikelnummer</th><th>Name</th><th>AuftragsNr.</th><th>EK brutto €</th><th>Bezahlt</th><th>Aktionen</th></tr>
  </table>
  <p id="verbindlichkeitenSumme" style="margin-top:10px;font-weight:bold;"></p>
</div>

<!-- Artikel Hinzufügen Modal -->
<div id="artikelAddModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeArtikelAddModal()">&times;</span>
    <h2>Artikel hinzufügen</h2>
    <label for="addArtikelNummer">Artikelnummer</label>
    <input id="addArtikelNummer" type="text">
    <label for="addArtikelName">Artikelname</label>
    <input id="addArtikelName" type="text">
    <label for="addArtikelBeschreibung">Beschreibung</label>
    <input id="addArtikelBeschreibung" type="text">
    <label for="addArtikelAuftragsNummer">Auftragsnummer</label>
    <input id="addArtikelAuftragsNummer" type="text">
    <label for="addArtikelWareneingang">Wareneingang (Datum)</label>
    <input id="addArtikelWareneingang" type="date">
    <label>Herkunft:</label>
    <label><input type="checkbox" id="addArtikelLager"> L (Lager)</label>
    <label><input type="checkbox" id="addArtikelKommission"> B (Kommissions Bestellung)</label>
    <label for="addArtikelEK">Einkaufspreis brutto (inkl. Vorsteuer)</label>
    <input id="addArtikelEK" type="number" step="0.01">
    <label for="addArtikelVK">Verkaufspreis brutto (inkl. MwSt)</label>
    <input id="addArtikelVK" type="number" step="0.01">
    <label for="addArtikelMenge">Menge</label>
    <input id="addArtikelMenge" type="number">
    <label for="addArtikelSteuer">Steuersatz (%)</label>
    <input id="addArtikelSteuer" type="number" value="19">
    <label><input type="checkbox" id="addArtikelInAusstellung"> In Ausstellung</label>
    <label for="addArtikelBezahlt">Bezahlt (Datum)</label>
    <input id="addArtikelBezahlt" type="date">
    <button onclick="artikelHinzufuegenFromModal()">Hinzufügen</button>
  </div>
</div>

<!-- Artikel Bearbeiten Modal -->
<div id="artikelEditModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="document.getElementById('artikelEditModal').style.display='none'">&times;</span>
    <h2>Artikel bearbeiten</h2>
    <label for="editArtikelNummer">Artikelnummer</label>
    <input id="editArtikelNummer" type="text">
    <label for="editArtikelName">Artikelname</label>
    <input id="editArtikelName" type="text">
    <label for="editArtikelBeschreibung">Beschreibung</label>
    <input id="editArtikelBeschreibung" type="text">
    <label for="editArtikelAuftragsNummer">Auftragsnummer</label>
    <input id="editArtikelAuftragsNummer" type="text">
    <label for="editArtikelWareneingang">Wareneingang (Datum)</label>
    <input id="editArtikelWareneingang" type="date">
    <label>Herkunft:</label>
    <label><input type="checkbox" id="editArtikelLager"> L (Lager)</label>
    <label><input type="checkbox" id="editArtikelKommission"> B (Kommissions Bestellung)</label>
    <label for="editArtikelEK">Einkaufspreis brutto (inkl. Vorsteuer)</label>
    <input id="editArtikelEK" type="number" step="0.01">
    <label for="editArtikelVK">Verkaufspreis brutto (inkl. MwSt)</label>
    <input id="editArtikelVK" type="number" step="0.01">
    <label for="editArtikelMenge">Menge</label>
    <input id="editArtikelMenge" type="number">
    <label for="editArtikelSteuer">Steuersatz (%)</label>
    <input id="editArtikelSteuer" type="number">
    <label><input type="checkbox" id="editArtikelInAusstellung"> In Ausstellung</label>
    <label for="editArtikelBezahlt">Bezahlt (Datum)</label>
    <input id="editArtikelBezahlt" type="date">
    <button onclick="artikelAenderungSpeichern()">Änderung speichern</button>
  </div>
</div>

<!-- Kundendaten Modal -->
<div id="kundeModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeKundeModal()">&times;</span>
    <h3>Kundendaten & Zahlung</h3>
    <label for="kundeVorname">Vorname</label>
    <input type="text" id="kundeVorname" placeholder="Vorname">
    <label for="kundeNachname">Nachname</label>
    <input type="text" id="kundeNachname" placeholder="Nachname">
    <label for="kundeStrasse">Straße</label>
    <input type="text" id="kundeStrasse" placeholder="Straße">
    <label for="kundePLZ">PLZ</label>
    <input type="text" id="kundePLZ" placeholder="PLZ">
    <label for="kundeRuf">Rufnummer</label>
    <input type="text" id="kundeRuf" placeholder="Rufnummer">
    <label for="kundeEmail">E-Mail</label>
    <input type="email" id="kundeEmail" placeholder="E-Mail">
    <label for="kundeAnzahlung">Anzahlung</label>
    <input type="number" id="kundeAnzahlung" placeholder="Anzahlung" step="0.01">
    <label for="kundeZahlungsart">Zahlungsart</label>
    <select id="kundeZahlungsart" onchange="toggleUeberweisungDatum()">
      <option value="Bar">Bar</option>
      <option value="EC/Kreditkarte">EC/Kreditkarte</option>
      <option value="Überweisung">Überweisung</option>
    </select>
    <label for="ueberweisungsDatum">Überweisungsdatum</label>
    <input type="date" id="ueberweisungsDatum" style="display:none;">
    <button onclick="saveKaufvertrag()">Speichern & Kaufvertrag abschließen</button>
  </div>
</div>

<!-- Kaufvertrag Bearbeiten Modal -->
<div id="kaufvertragEditModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="document.getElementById('kaufvertragEditModal').style.display='none'">&times;</span>
    <h2>Kaufvertrag bearbeiten</h2>
    <label for="editAusgeliefert">Ausgeliefert Datum</label>
    <input id="editAusgeliefert" type="date">
    <label for="editAbgerechnet">Abgerechnet Datum</label>
    <input id="editAbgerechnet" type="date">
    <label for="editHerstellerBezahlt">Herstellerverbindlichkeiten bezahlt (Datum)</label>
    <input id="editHerstellerBezahlt" type="date">
    <label for="editAuftragsNummer">Auftragsbestätigungsnummer</label>
    <input id="editAuftragsNummer" type="text">
    <h3>Artikel bearbeiten</h3>
    <table id="editArtikelTabelle">
      <tr><th>Artikelname</th><th>Artikelnummer</th><th>Beschreibung</th><th>EK brutto</th><th>VK brutto</th><th>Aktionen</th></tr>
    </table>
    <button onclick="kaufvertragAenderungSpeichern()">Änderung speichern</button>
  </div>
</div>

<!-- Einzelnen Artikel im Kaufvertrag bearbeiten Modal -->
<div id="artikelInKaufvertragEditModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="document.getElementById('artikelInKaufvertragEditModal').style.display='none'">&times;</span>
    <h2>Artikel im Kaufvertrag bearbeiten</h2>
    <label for="editArtikelInKaufvertragName">Artikelname</label>
    <input id="editArtikelInKaufvertragName" type="text">
    <label for="editArtikelInKaufvertragNummer">Artikelnummer</label>
    <input id="editArtikelInKaufvertragNummer" type="text">
    <label for="editArtikelInKaufvertragBeschreibung">Beschreibung</label>
    <input id="editArtikelInKaufvertragBeschreibung" type="text">
    <label for="editArtikelInKaufvertragEK">EK brutto</label>
    <input id="editArtikelInKaufvertragEK" type="number" step="0.01">
    <label for="editArtikelInKaufvertragVK">VK brutto</label>
    <input id="editArtikelInKaufvertragVK" type="number" step="0.01">
    <button onclick="artikelInKaufvertragAenderungSpeichern()">Änderung speichern</button>
  </div>
</div>

<script>
// Hilfsfunktion: MwSt aus Bruttobetrag berechnen
function mwstAusBrutto(brutto, steuersatz) {
  return brutto * steuersatz / (100 + steuersatz);
}

// Login
function checkLogin() {
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  if (user === "CasaDivani" && pass === "CD2025") {
    document.getElementById('loginModal').style.display = 'none';
  } else {
    document.getElementById('loginError').innerText = "Benutzername oder Passwort falsch!";
  }
}
document.getElementById('loginPass').addEventListener('keyup', function(e) {
  if (e.key === "Enter") checkLogin();
});

// Daten
let lager = [], aktuelleKaufvertragArtikel = [], archiv = [], laufendeNummern = {};

let aktuellBearbeitenArchivIndex = null;
let aktuellBearbeitenArtikelIndex = null;

// Tabs
function switchTab(tabId) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
  document.getElementById(tabId).classList.add('active');
  if (tabId === 'verkaufTab') updateVerkaufTabelle();
  if (tabId === 'archivTab') updateArchivTabelle();
  if (tabId === 'steuerTab') updateSteuerTabelle();
  if (tabId === 'umsatzTab') updateUmsatzTabelle();
  if (tabId === 'forderungenTab') updateForderungenVerbindlichkeiten();
  if (tabId === 'artikelTab') filterLager();
}

// Artikelverwaltung
function openArtikelAddModal() {
  ['addArtikelNummer','addArtikelName','addArtikelBeschreibung','addArtikelAuftragsNummer','addArtikelWareneingang','addArtikelEK','addArtikelVK','addArtikelMenge','addArtikelBezahlt'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('addArtikelLager').checked = false;
  document.getElementById('addArtikelKommission').checked = false;
  document.getElementById('addArtikelInAusstellung').checked = false;
  document.getElementById('addArtikelSteuer').value = 19;
  document.getElementById('artikelAddModal').style.display = 'flex';
}

function closeArtikelAddModal() {
  document.getElementById('artikelAddModal').style.display = 'none';
}

function artikelHinzufuegenFromModal() {
  const artikelNummer = document.getElementById('addArtikelNummer').value.trim();
  const name = document.getElementById('addArtikelName').value.trim();
  const beschreibung = document.getElementById('addArtikelBeschreibung').value.trim();
  const auftragsNummer = document.getElementById('addArtikelAuftragsNummer').value.trim();
  const wareneingang = document.getElementById('addArtikelWareneingang').value;
  const lagerHerkunft = document.getElementById('addArtikelLager').checked;
  const kommissionHerkunft = document.getElementById('addArtikelKommission').checked;
  const ek = parseFloat(document.getElementById('addArtikelEK').value);
  const vk = parseFloat(document.getElementById('addArtikelVK').value);
  const menge = parseInt(document.getElementById('addArtikelMenge').value);
  const steuer = parseInt(document.getElementById('addArtikelSteuer').value);
  const inAusstellung = document.getElementById('addArtikelInAusstellung').checked;
  const bezahlt = document.getElementById('addArtikelBezahlt').value || null;

  if (!artikelNummer || !name || isNaN(ek) || isNaN(vk) || isNaN(menge) || menge <= 0) {
    alert("Bitte alle Felder korrekt ausfüllen!");
    return;
  }

  const marge = (vk / ek).toFixed(2);

  lager.push({ artikelNummer, name, beschreibung, auftragsNummer, wareneingang, lagerHerkunft, kommissionHerkunft, ek, vk, menge, steuer, inAusstellung, marge, bezahlt });
  closeArtikelAddModal();
  filterLager();
  updateVerkaufTabelle();
}

function editArtikel(index) {
  const a = lager[index];
  aktuellBearbeitenIndex = index;
  document.getElementById('editArtikelNummer').value = a.artikelNummer;
  document.getElementById('editArtikelName').value = a.name;
  document.getElementById('editArtikelBeschreibung').value = a.beschreibung;
  document.getElementById('editArtikelAuftragsNummer').value = a.auftragsNummer;
  document.getElementById('editArtikelWareneingang').value = a.wareneingang || '';
  document.getElementById('editArtikelLager').checked = a.lagerHerkunft;
  document.getElementById('editArtikelKommission').checked = a.kommissionHerkunft;
  document.getElementById('editArtikelEK').value = a.ek;
  document.getElementById('editArtikelVK').value = a.vk;
  document.getElementById('editArtikelMenge').value = a.menge;
  document.getElementById('editArtikelSteuer').value = a.steuer;
  document.getElementById('editArtikelInAusstellung').checked = a.inAusstellung;
  document.getElementById('editArtikelBezahlt').value = a.bezahlt || '';
  document.getElementById('artikelEditModal').style.display = 'flex';
}

function artikelAenderungSpeichern() {
  if (aktuellBearbeitenIndex === null) return;
  const ek = parseFloat(document.getElementById('editArtikelEK').value);
  const vk = parseFloat(document.getElementById('editArtikelVK').value);
  lager[aktuellBearbeitenIndex] = {
    artikelNummer: document.getElementById('editArtikelNummer').value.trim(),
    name: document.getElementById('editArtikelName').value.trim(),
    beschreibung: document.getElementById('editArtikelBeschreibung').value.trim(),
    auftragsNummer: document.getElementById('editArtikelAuftragsNummer').value.trim(),
    wareneingang: document.getElementById('editArtikelWareneingang').value || null,
    lagerHerkunft: document.getElementById('editArtikelLager').checked,
    kommissionHerkunft: document.getElementById('editArtikelKommission').checked,
    ek, vk,
    menge: parseInt(document.getElementById('editArtikelMenge').value),
    steuer: parseInt(document.getElementById('editArtikelSteuer').value),
    inAusstellung: document.getElementById('editArtikelInAusstellung').checked,
    marge: (vk / ek).toFixed(2),
    bezahlt: document.getElementById('editArtikelBezahlt').value || null
  };
  aktuellBearbeitenIndex = null;
  document.getElementById('artikelEditModal').style.display = 'none';
  filterLager();
  updateVerkaufTabelle();
  updateForderungenVerbindlichkeiten();
}

function isArtikelComplete(a) {
  return a.artikelNummer && a.name && a.beschreibung && a.auftragsNummer && a.wareneingang && (a.lagerHerkunft || a.kommissionHerkunft) && a.ek && a.vk && a.menge && a.steuer && a.bezahlt;
}

function filterLager() {
  const filter = document.getElementById('lagerSuche').value.toLowerCase().trim();
  const terms = filter.split(/\s+/);
  const table = document.getElementById('lagerTabelle');
  table.innerHTML = `<tr><th>Nr.</th><th>Name</th><th>Beschreibung</th><th>AuftragsNr.</th><th>Wareneingang</th><th>Herkunft</th><th>EK brutto</th><th>VK brutto</th><th>Marge Faktor</th><th>Menge</th><th>Steuer %</th><th>In Ausstellung</th><th>Aktionen</th><th>Bezahlt</th></tr>`;

  lager.forEach((a, i) => {
    const text = (a.artikelNummer + ' ' + a.name + ' ' + a.beschreibung).toLowerCase();
    if (terms.every(term => text.includes(term))) {
      const herkunft = [];
      if (a.lagerHerkunft) herkunft.push('L');
      if (a.kommissionHerkunft) herkunft.push('B');
      const herkunftText = herkunft.join(', ') || '-';

      const row = table.insertRow();
      if (isArtikelComplete(a)) row.classList.add('complete');
      row.insertCell(0).innerText = a.artikelNummer;
      row.insertCell(1).innerText = a.name;
      row.insertCell(2).innerText = a.beschreibung;
      row.insertCell(3).innerText = a.auftragsNummer;
      row.insertCell(4).innerText = a.wareneingang || '-';
      row.insertCell(5).innerText = herkunftText;
      row.insertCell(6).innerText = a.ek.toFixed(2);
      row.insertCell(7).innerText = a.vk.toFixed(2);
      row.insertCell(8).innerText = a.marge;
      row.insertCell(9).innerText = a.menge;
      row.insertCell(10).innerText = a.steuer + '%';
      row.insertCell(11).innerText = a.inAusstellung ? 'Ja' : 'Nein';

      const cell = row.insertCell(12);
      const btnEdit = document.createElement('button');
      btnEdit.className = 'btn btn-edit'; btnEdit.innerText = 'Bearbeiten';
      btnEdit.onclick = () => editArtikel(i);
      const btnDel = document.createElement('button');
      btnDel.className = 'btn btn-delete'; btnDel.innerText = 'Löschen';
      btnDel.onclick = () => { lager.splice(i, 1); filterLager(); updateVerkaufTabelle(); };
      cell.appendChild(btnEdit);
      cell.appendChild(btnDel);

      row.insertCell(13).innerText = a.bezahlt || '-';
    }
  });
}

// Kaufvertrag
function updateVerkaufTabelle() {
  const filter = document.getElementById('verkaufSuche').value.toLowerCase().trim();
  const terms = filter.split(/\s+/);
  const table = document.getElementById('verkaufTabelle');
  table.innerHTML = '<tr><th>Artikelname</th><th>Artikelnummer</th><th>Beschreibung</th><th>VK brutto</th><th>Menge</th><th>MwSt €</th><th>Aktion</th></tr>';
  lager.forEach((a, i) => {
    const text = (a.artikelNummer + ' ' + a.name + ' ' + a.beschreibung).toLowerCase();
    if (a.menge > 0 && terms.every(term => text.includes(term))) {
      const mwst = mwstAusBrutto(a.vk, a.steuer);
      const row = table.insertRow();
      row.insertCell(0).innerText = a.name;
      row.insertCell(1).innerText = a.artikelNummer;
      row.insertCell(2).innerText = a.beschreibung;
      row.insertCell(3).innerText = a.vk.toFixed(2);
      row.insertCell(4).innerText = a.menge;
      row.insertCell(5).innerText = mwst.toFixed(2);
      const cell = row.insertCell(6);
      const btn = document.createElement('button');
      btn.className = 'btn btn-verkaufen'; btn.innerText = 'Hinzufügen';
      btn.onclick = () => addToKaufvertrag(i);
      cell.appendChild(btn);
    }
  });
}

function addToKaufvertrag(index) {
  const artikel = lager[index];
  aktuelleKaufvertragArtikel.push({ ...artikel });
  artikel.menge -= 1;
  if (artikel.menge <= 0) lager.splice(index, 1);
  filterLager();
  updateVerkaufTabelle();
  updateAktuelleKaufvertragTabelle();
}

function updateAktuelleKaufvertragTabelle() {
  const table = document.getElementById('aktuelleKaufvertragTabelle');
  table.innerHTML = '<tr><th>Artikelname</th><th>Artikelnummer</th><th>Beschreibung</th><th>Menge</th><th>VK brutto</th><th>MwSt €</th><th>Aktion</th></tr>';
  aktuelleKaufvertragArtikel.forEach((a, i) => {
    const mwst = mwstAusBrutto(a.vk, a.steuer);
    const row = table.insertRow();
    row.insertCell(0).innerText = a.name;
    row.insertCell(1).innerText = a.artikelNummer;
    row.insertCell(2).innerText = a.beschreibung;
    row.insertCell(3).innerText = 1;
    row.insertCell(4).innerText = a.vk.toFixed(2);
    row.insertCell(5).innerText = mwst.toFixed(2);
    const cell = row.insertCell(6);
    const btn = document.createElement('button');
    btn.className = 'btn btn-delete'; btn.innerText = 'Entfernen';
    btn.onclick = () => removeFromKaufvertrag(i);
    cell.appendChild(btn);
  });
}

function removeFromKaufvertrag(index) {
  const a = aktuelleKaufvertragArtikel[index];
  const exist = lager.find(x => x.artikelNummer === a.artikelNummer);
  if (exist) exist.menge += 1;
  else lager.push({ ...a, menge: 1 });
  aktuelleKaufvertragArtikel.splice(index, 1);
  filterLager();
  updateVerkaufTabelle();
  updateAktuelleKaufvertragTabelle();
}

function openKundeModal() { document.getElementById('kundeModal').style.display = 'flex'; }
function closeKundeModal() { document.getElementById('kundeModal').style.display = 'none'; }
function toggleUeberweisungDatum() {
  const sel = document.getElementById('kundeZahlungsart').value;
  document.getElementById('ueberweisungsDatum').style.display = (sel === 'Überweisung') ? 'block' : 'none';
}

function saveKaufvertrag() {
  if (aktuelleKaufvertragArtikel.length === 0) { alert("Keine Artikel im Kaufvertrag!"); return; }
  const vorname = document.getElementById('kundeVorname').value.trim();
  const nachname = document.getElementById('kundeNachname').value.trim();
  if (!vorname || !nachname) { alert("Bitte Kundendaten ausfüllen!"); return; }

  const kunde = {
    vorname, nachname,
    strasse: document.getElementById('kundeStrasse').value,
    plz: document.getElementById('kundePLZ').value,
    ruf: document.getElementById('kundeRuf').value,
    email: document.getElementById('kundeEmail').value,
    anzahlung: parseFloat(document.getElementById('kundeAnzahlung').value) || 0,
    zahlungsart: document.getElementById('kundeZahlungsart').value,
    ueberweisungsDatum: document.getElementById('ueberweisungsDatum').value
  };

  const jahr = new Date().getFullYear();
  if (!laufendeNummern[jahr]) laufendeNummern[jahr] = 0;
  laufendeNummern[jahr] += 1;
  const kaufvertragsnummer = `CD${jahr}${String(laufendeNummern[jahr]).padStart(3, '0')}`;

  let gesamt = 0;
  aktuelleKaufvertragArtikel.forEach(a => gesamt += a.vk);

  const originalRestbetrag = gesamt - kunde.anzahlung;

  archiv.push({
    kaufvertragsnummer,
    kunde,
    datum: new Date().toLocaleDateString(),
    gesamtbetrag: gesamt,
    artikel: [...aktuelleKaufvertragArtikel],
    anzahlung: kunde.anzahlung,
    restbetrag: originalRestbetrag,
    originalRestbetrag: originalRestbetrag,
    auftragsNummer: '',
    ausgeliefert: null,
    abgerechnet: null,
    herstellerBezahlt: null
  });

  aktuelleKaufvertragArtikel = [];
  updateAktuelleKaufvertragTabelle();
  updateArchivTabelle();
  updateSteuerTabelle();
  updateUmsatzTabelle();
  closeKundeModal();
  ['kundeVorname', 'kundeNachname', 'kundeStrasse', 'kundePLZ', 'kundeRuf', 'kundeEmail', 'kundeAnzahlung', 'ueberweisungsDatum'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('kundeZahlungsart').value = 'Bar';
  toggleUeberweisungDatum();
  alert("Kaufvertrag abgeschlossen und Kunde angelegt!");
}

function editKaufvertrag(index) {
  const k = archiv[index];
  aktuellBearbeitenArchivIndex = index;
  document.getElementById('editAusgeliefert').value = k.ausgeliefert || '';
  document.getElementById('editAbgerechnet').value = k.abgerechnet || '';
  document.getElementById('editHerstellerBezahlt').value = k.herstellerBezahlt || '';
  document.getElementById('editAuftragsNummer').value = k.auftragsNummer || '';
  const table = document.getElementById('editArtikelTabelle');
  table.innerHTML = '<tr><th>Artikelname</th><th>Artikelnummer</th><th>Beschreibung</th><th>EK brutto</th><th>VK brutto</th><th>Aktionen</th></tr>';
  k.artikel.forEach((a, j) => {
    const row = table.insertRow();
    row.insertCell(0).innerText = a.name;
    row.insertCell(1).innerText = a.artikelNummer;
    row.insertCell(2).innerText = a.beschreibung;
    row.insertCell(3).innerText = a.ek.toFixed(2);
    row.insertCell(4).innerText = a.vk.toFixed(2);
    const cell = row.insertCell(5);
    const btnEdit = document.createElement('button');
    btnEdit.className = 'btn btn-edit'; btnEdit.innerText = 'Bearbeiten';
    btnEdit.onclick = () => editArtikelInKaufvertrag(j);
    cell.appendChild(btnEdit);
  });
  document.getElementById('kaufvertragEditModal').style.display = 'flex';
}

function editArtikelInKaufvertrag(artikelIndex) {
  const k = archiv[aktuellBearbeitenArchivIndex];
  const a = k.artikel[artikelIndex];
  aktuellBearbeitenArtikelIndex = artikelIndex;
  document.getElementById('editArtikelInKaufvertragName').value = a.name;
  document.getElementById('editArtikelInKaufvertragNummer').value = a.artikelNummer;
  document.getElementById('editArtikelInKaufvertragBeschreibung').value = a.beschreibung;
  document.getElementById('editArtikelInKaufvertragEK').value = a.ek;
  document.getElementById('editArtikelInKaufvertragVK').value = a.vk;
  document.getElementById('artikelInKaufvertragEditModal').style.display = 'flex';
}

function artikelInKaufvertragAenderungSpeichern() {
  if (aktuellBearbeitenArchivIndex === null || aktuellBearbeitenArtikelIndex === null) return;
  const k = archiv[aktuellBearbeitenArchivIndex];
  const a = k.artikel[aktuellBearbeitenArtikelIndex];
  a.name = document.getElementById('editArtikelInKaufvertragName').value.trim();
  a.artikelNummer = document.getElementById('editArtikelInKaufvertragNummer').value.trim();
  a.beschreibung = document.getElementById('editArtikelInKaufvertragBeschreibung').value.trim();
  a.ek = parseFloat(document.getElementById('editArtikelInKaufvertragEK').value);
  a.vk = parseFloat(document.getElementById('editArtikelInKaufvertragVK').value);
  aktuellBearbeitenArtikelIndex = null;
  document.getElementById('artikelInKaufvertragEditModal').style.display = 'none';
  editKaufvertrag(aktuellBearbeitenArchivIndex);
  updateSteuerTabelle();
  updateUmsatzTabelle();
}

function kaufvertragAenderungSpeichern() {
  if (aktuellBearbeitenArchivIndex === null) return;
  const ausgeliefert = document.getElementById('editAusgeliefert').value || null;
  const abgerechnet = document.getElementById('editAbgerechnet').value || null;
  const herstellerBezahlt = document.getElementById('editHerstellerBezahlt').value || null;
  const auftragsNummer = document.getElementById('editAuftragsNummer').value.trim();

  const k = archiv[aktuellBearbeitenArchivIndex];
  k.ausgeliefert = ausgeliefert;
  k.abgerechnet = abgerechnet;
  k.herstellerBezahlt = herstellerBezahlt;
  k.auftragsNummer = auftragsNummer;

  if (abgerechnet) {
    k.restbetrag = 0;
  } else {
    k.restbetrag = k.originalRestbetrag;
  }

  aktuellBearbeitenArchivIndex = null;
  document.getElementById('kaufvertragEditModal').style.display = 'none';
  updateArchivTabelle();
  updateSteuerTabelle();
  updateUmsatzTabelle();
  updateForderungenVerbindlichkeiten();
}

function isArchivComplete(k) {
  return k.ausgeliefert && k.abgerechnet && k.herstellerBezahlt;
}

function updateArchivTabelle() {
  const filter = document.getElementById('archivSuche').value.toLowerCase().trim();
  const table = document.getElementById('archivTabelle');
  table.innerHTML = '<tr><th>Kaufvertragsnummer</th><th>Kunde</th><th>Datum</th><th>Gesamtbetrag</th><th>Anzahlung</th><th>Restbetrag</th><th>Auftragsbestätigungsnummer</th><th>Ausgeliefert</th><th>Abgerechnet</th><th>Herstellerverbindlichkeiten bezahlt</th><th>Aktionen</th></tr>';
  archiv.forEach((k, i) => {
    const text = (k.kaufvertragsnummer + ' ' + k.kunde.vorname + ' ' + k.kunde.nachname).toLowerCase();
    if (filter === '' || text.includes(filter)) {
      const row = table.insertRow();
      if (isArchivComplete(k)) row.classList.add('complete');
      row.insertCell(0).innerText = k.kaufvertragsnummer;
      row.insertCell(1).innerText = k.kunde.vorname + ' ' + k.kunde.nachname;
      row.insertCell(2).innerText = k.datum;
      row.insertCell(3).innerText = k.gesamtbetrag.toFixed(2);
      row.insertCell(4).innerText = k.anzahlung.toFixed(2);
      row.insertCell(5).innerText = k.restbetrag.toFixed(2);
      row.insertCell(6).innerText = k.auftragsNummer || '-';
      row.insertCell(7).innerText = k.ausgeliefert || '-';
      row.insertCell(8).innerText = k.abgerechnet || '-';
      row.insertCell(9).innerText = k.herstellerBezahlt || '-';
      const cell = row.insertCell(10);
      const btnEdit = document.createElement('button');
      btnEdit.className = 'btn btn-edit'; btnEdit.innerText = 'Bearbeiten';
      btnEdit.onclick = () => editKaufvertrag(i);
      const btnDel = document.createElement('button');
      btnDel.className = 'btn btn-delete'; btnDel.innerText = 'Löschen';
      btnDel.onclick = () => {
        archiv.splice(i, 1);
        updateArchivTabelle();
        updateSteuerTabelle();
        updateUmsatzTabelle();
        updateForderungenVerbindlichkeiten();
      };
      const btnPDF = document.createElement('button');
      btnPDF.className = 'btn btn-pdf'; btnPDF.innerText = 'Kaufvertrag PDF';
      btnPDF.onclick = () => downloadKaufvertragPDF(k);
      cell.appendChild(btnEdit);
      cell.appendChild(btnDel);
      cell.appendChild(btnPDF);
      if (k.artikel.some(a => a.kommissionHerkunft)) {
        const btnHerstellerPDF = document.createElement('button');
        btnHerstellerPDF.className = 'btn btn-pdf'; btnHerstellerPDF.innerText = 'Herstellerbestellung PDF';
        btnHerstellerPDF.onclick = () => downloadHerstellerbestellungPDF(k);
        cell.appendChild(btnHerstellerPDF);
      }
    }
  });
}

function downloadKaufvertragPDF(k) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Footer SOFORT definieren – direkt nach Erstellung des Dokuments!
  doc.didDrawPage = function (data) {
    const pageHeight = doc.internal.pageSize.getHeight();
    doc.setFontSize(9);
    doc.setTextColor(100);
    const footerY = pageHeight - 15;
    doc.text("Folge uns: Instagram | TikTok | Facebook  |  #CasaDivani", 20, footerY);
    doc.text("www.casa-divani.de | info@casa-divani.de | Tel: 01234-567890", 20, footerY + 5);
  };

  doc.setFont("helvetica");

  const logoUrl = "https://i.imgur.com/o8Lowx7.png";
  const img = new Image();
  img.crossOrigin = "Anonymous";

  img.onload = function () {
    // Jetzt alles auf Seite 1 zeichnen
    doc.addImage(img, 'PNG', 170, 8, 30, 30);

    doc.setFontSize(16);
    doc.setFont(undefined, "bold");
    doc.text("Casa Divani", 20, 20);

    doc.setFontSize(10);
    doc.setFont(undefined, "normal");
    doc.text("Musterstrasse 1, 11111 Musterstadt", 20, 28);
    doc.text("Telefon: 01234-567890 | E-Mail: info@casadivani.de", 20, 34);

    doc.setFontSize(12);
    doc.setFont(undefined, "bold");
    doc.text(`Kaufvertragsnummer: ${k.kaufvertragsnummer}`, 150, 20, { align: "right" });

    doc.setFontSize(11);
    doc.setFont(undefined, "normal");
    doc.text(`Kunde: ${k.kunde.vorname} ${k.kunde.nachname}`, 20, 44);
    doc.text(`Adresse: ${k.kunde.strasse}, ${k.kunde.plz}`, 20, 50);
    if (k.kunde.email) doc.text(`E-Mail: ${k.kunde.email}`, 20, 56);
    if (k.kunde.ruf) doc.text(`Telefon: ${k.kunde.ruf}`, 20, 62);

    const artikelRows = k.artikel.map(a => [
      a.name,
      a.artikelNummer,
      a.beschreibung,
      '1',
      a.vk.toFixed(2),
      mwstAusBrutto(a.vk, a.steuer).toFixed(2)
    ]);

    doc.autoTable({
      head: [['Artikel', 'Nummer', 'Beschreibung', 'Menge', 'VK inkl. MwSt €', 'MwSt €']],
      body: artikelRows,
      startY: 70,
      styles: { fontSize: 10, cellPadding: 3 },
      headStyles: { fillColor: [100, 100, 100], textColor: 255, fontStyle: 'bold' },
      alternateRowStyles: { fillColor: [240, 240, 240] },
      margin: { left: 20, right: 20 }
    });

    const yPos = doc.lastAutoTable.finalY + 10;
    doc.setFontSize(11);
    doc.setFont(undefined, "bold");
    doc.text("Zahlungsübersicht", 20, yPos);

    doc.autoTable({
      startY: yPos + 5,
      theme: 'grid',
      styles: { fontSize: 10, cellPadding: 3 },
      headStyles: { fillColor: [100, 100, 100], textColor: 255, fontStyle: 'bold' },
      head: [['Bezeichnung', 'Betrag €']],
      body: [
        ['Gesamtbetrag', k.gesamtbetrag.toFixed(2)],
        ['Anzahlung', k.anzahlung.toFixed(2)],
        ['Restbetrag', k.restbetrag.toFixed(2)]
      ],
      margin: { left: 20, right: 20 }
    });

    // Seite 2: AGB
    doc.addPage();
    doc.addImage(img, 'PNG', 170, 8, 30, 30);
    doc.setFontSize(16);
    doc.setFont(undefined, "bold");
    doc.text("Casa Divani", 20, 20);
    doc.setFontSize(14);
    doc.text("Allgemeine Geschäftsbedingungen (AGB)", 20, 40);
    doc.setFontSize(10);
    doc.setFont(undefined, "normal");

    const agbText = [
      "1. Geltungsbereich",
      "Diese Allgemeinen Geschäftsbedingungen gelten für alle Verträge über den Kauf von Waren in unserem Geschäft bzw. über unsere Website.",
      "",
      "2. Vertragsschluss",
      "Der Kaufvertrag kommt durch Übergabe der Ware und Zahlung des Kaufpreises bzw. durch Unterzeichnung des Kaufvertrags zustande.",
      "",
      "3. Preise und Zahlung",
      "Die angegebenen Preise sind Endpreise inkl. gesetzlicher Mehrwertsteuer. Zahlung erfolgt bar, per EC-/Kreditkarte oder per Überweisung. Bei Überweisung ist der Betrag innerhalb von 7 Tagen fällig.",
      "",
      "4. Eigentumsvorbehalt",
      "Die Ware bleibt bis zur vollständigen Bezahlung unser Eigentum.",
      "",
      "5. Lieferung und Montage",
      "Liefertermine sind unverbindlich, es sei denn, sie wurden ausdrücklich schriftlich als verbindlich vereinbart. Montageleistungen sind gesondert zu vergüten, sofern nicht anders vereinbart.",
      "",
      "6. Gewährleistung",
      "Es gelten die gesetzlichen Gewährleistungsregelungen. Offensichtliche Mängel sind unverzüglich, spätestens innerhalb von 14 Tagen nach Erhalt der Ware, zu rügen.",
      "",
      "7. Widerrufsrecht",
      "Bei Fernabsatzverträgen (z. B. Online-Bestellung) besteht ein gesetzliches Widerrufsrecht von 14 Tagen. Bei Maßanfertigungen oder individuell gefertigten Möbeln ist das Widerrufsrecht ausgeschlossen (§ 312g Abs. 2 Nr. 1 BGB).",
      "",
      "8. Datenschutz",
      "Ihre personenbezogenen Daten werden ausschließlich zur Abwicklung des Vertragsverhältnisses verwendet und gemäß DSGVO geschützt.",
      "",
      "9. Schlussbestimmungen",
      "Erfüllungsort und Gerichtsstand ist Musterstadt. Es gilt deutsches Recht. Sollten einzelne Bestimmungen unwirksam sein, bleibt die Wirksamkeit der übrigen Bestimmungen unberührt.",
      "",
      "Stand: Dezember 2025"
    ];

    doc.text(agbText, 20, 60, { lineHeightFactor: 1.5, maxWidth: 170 });

    doc.save(`Kaufvertrag_${k.kaufvertragsnummer}.pdf`);
  };

  img.onerror = function () {
    // Fallback: PDF ohne Logo erstellen, aber Footer ist trotzdem da!
    alert("Logo konnte nicht geladen werden – PDF wird ohne Logo erstellt.");
    doc.save(`Kaufvertrag_${k.kaufvertragsnummer}.pdf`);
  };

  img.src = logoUrl;
}

function downloadHerstellerbestellungPDF(k) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const logoUrl = "https://i.imgur.com/o8Lowx7.png";
  const img = new Image();
  img.crossOrigin = "Anonymous";

  img.onload = function () {
    doc.setFont("helvetica");

    doc.didDrawPage = function (data) {
      const pageHeight = doc.internal.pageSize.getHeight();
      doc.setFontSize(9);
      doc.setTextColor(100);
      const footerY = pageHeight - 15;
      doc.text("Folge uns: Instagram | TikTok | Facebook  |  #CasaDivani", 20, footerY);
      doc.text("www.casa-divani.de | info@casa-divani.de | Tel: 01234-567890", 20, footerY + 5);
    };

    doc.addImage(img, 'PNG', 170, 8, 30, 30);

    doc.setFontSize(16);
    doc.setFont(undefined, "bold");
    doc.text("Casa Divani", 20, 20);

    doc.setFontSize(10);
    doc.setFont(undefined, "normal");
    doc.text("Musterstrasse 1, 11111 Musterstadt", 20, 28);
    doc.text("Telefon: 01234-567890 | E-Mail: info@casadivani.de", 20, 34);

    doc.setFontSize(12);
    doc.setFont(undefined, "bold");
    doc.text(`Kaufvertragsnummer: ${k.kaufvertragsnummer}`, 150, 20, { align: "right" });

    doc.setFontSize(11);
    doc.setFont(undefined, "normal");
    doc.text(`Kunde: ${k.kunde.vorname} ${k.kunde.nachname}`, 20, 44);
    doc.text(`Datum: ${k.datum}`, 20, 50);

    const artikelRows = k.artikel.map(a => [
      a.name,
      a.artikelNummer,
      a.beschreibung,
      '1'
    ]);

    doc.autoTable({
      head: [['Artikelname', 'Artikelnummer', 'Beschreibung', 'Menge']],
      body: artikelRows,
      startY: 60,
      styles: { fontSize: 10, cellPadding: 3 },
      headStyles: { fillColor: [100, 100, 100], textColor: 255, fontStyle: 'bold' },
      alternateRowStyles: { fillColor: [240, 240, 240] },
      margin: { left: 20, right: 20 }
    });

    doc.save(`Herstellerbestellung_${k.kaufvertragsnummer}.pdf`);
  };

  img.onerror = function () {
    alert("Logo konnte nicht geladen werden.");
  };

  img.src = logoUrl;
}

// Steuerbericht & Umsatz
function updateSteuerTabelle() {
  const table = document.getElementById('steuerTabelle');
  table.innerHTML = `<tr><th>Kaufvertragsnummer</th><th>Artikel</th><th>Menge</th><th>VK brutto</th><th>EK brutto</th><th>Umsatzsteuer €</th><th>Vorsteuer €</th><th>Steuerlast €</th></tr>`;

  let gesamtSteuerlast = 0;

  archiv.forEach(k => {
    k.artikel.forEach(a => {
      const ust = mwstAusBrutto(a.vk, a.steuer);
      const vst = mwstAusBrutto(a.ek, a.steuer);
      const steuerlast = ust - vst;

      const row = table.insertRow();
      row.insertCell(0).innerText = k.kaufvertragsnummer;
      row.insertCell(1).innerText = a.name;
      row.insertCell(2).innerText = '1';
      row.insertCell(3).innerText = a.vk.toFixed(2);
      row.insertCell(4).innerText = a.ek.toFixed(2);
      row.insertCell(5).innerText = ust.toFixed(2);
      row.insertCell(6).innerText = vst.toFixed(2);
      row.insertCell(7).innerText = steuerlast.toFixed(2);

      gesamtSteuerlast += steuerlast;
    });
  });

  document.getElementById('steuerSumme').innerText = `Gesamte Steuerlast: ${gesamtSteuerlast.toFixed(2)} €`;
  updateUmsatzTabelle();
}

function updateUmsatzTabelle() {
  const table = document.getElementById('umsatzTabelle');
  table.innerHTML = `<tr><th>Kaufvertragsnummer</th><th>Artikel</th><th>VK brutto €</th><th>EK brutto €</th><th>Reingewinn €</th></tr>`;

  let sumVK = 0, sumEK = 0, sumGewinn = 0;

  archiv.forEach(k => {
    k.artikel.forEach(a => {
      const ust = mwstAusBrutto(a.vk, a.steuer);
      const vst = mwstAusBrutto(a.ek, a.steuer);
      const steuerlast = ust - vst;
      const gewinn = (a.vk - a.ek) - steuerlast;

      sumVK += a.vk;
      sumEK += a.ek;
      sumGewinn += gewinn;

      const row = table.insertRow();
      row.insertCell(0).innerText = k.kaufvertragsnummer;
      row.insertCell(1).innerText = a.name;
      row.insertCell(2).innerText = a.vk.toFixed(2);
      row.insertCell(3).innerText = a.ek.toFixed(2);
      row.insertCell(4).innerText = gewinn.toFixed(2);
    });
  });

  document.getElementById('umsatzSumme').innerText =
    `Gesamt VK brutto: ${sumVK.toFixed(2)} € | Gesamt EK brutto: ${sumEK.toFixed(2)} € | Reingewinn: ${sumGewinn.toFixed(2)} €`;
}

// Forderungen/Verbindlichkeiten
function updateForderungenVerbindlichkeiten() {
  // Offene Forderungen
  const forderungenTable = document.getElementById('forderungenTabelle');
  forderungenTable.innerHTML = '<tr><th>Kaufvertragsnummer</th><th>Kunde</th><th>Restbetrag €</th><th>Bezahlt</th><th>Aktionen</th></tr>';
  let sumForderungen = 0;

  archiv.forEach((k, i) => {
    if (k.restbetrag > 0) {
      const row = forderungenTable.insertRow();
      row.insertCell(0).innerText = k.kaufvertragsnummer;
      row.insertCell(1).innerText = k.kunde.vorname + ' ' + k.kunde.nachname;
      row.insertCell(2).innerText = k.restbetrag.toFixed(2);
      row.insertCell(3).innerText = k.abgerechnet || '-';
      const cell = row.insertCell(4);
      const btnEdit = document.createElement('button');
      btnEdit.className = 'btn btn-edit'; btnEdit.innerText = 'Bearbeiten';
      btnEdit.onclick = () => editKaufvertrag(i);
      cell.appendChild(btnEdit);
      sumForderungen += k.restbetrag;
    }
  });

  document.getElementById('forderungenSumme').innerText = `Gesamte offene Forderungen: ${sumForderungen.toFixed(2)} €`;

  // Offene Verbindlichkeiten
  const verbindlichkeitenTable = document.getElementById('verbindlichkeitenTabelle');
  verbindlichkeitenTable.innerHTML = '<tr><th>Kaufvertragsnummer</th><th>Artikelnummer</th><th>Name</th><th>AuftragsNr.</th><th>EK brutto €</th><th>Bezahlt</th><th>Aktionen</th></tr>';
  let sumVerbindlichkeiten = 0;

  archiv.forEach((k, i) => {
    if (!k.herstellerBezahlt) {
      k.artikel.forEach(a => {
        const row = verbindlichkeitenTable.insertRow();
        row.insertCell(0).innerText = k.kaufvertragsnummer;
        row.insertCell(1).innerText = a.artikelNummer;
        row.insertCell(2).innerText = a.name;
        row.insertCell(3).innerText = a.auftragsNummer;
        const ekTotal = a.ek;
        row.insertCell(4).innerText = ekTotal.toFixed(2);
        row.insertCell(5).innerText = k.herstellerBezahlt || '-';
        const cell = row.insertCell(6);
        const btnEdit = document.createElement('button');
        btnEdit.className = 'btn btn-edit'; btnEdit.innerText = 'Bearbeiten';
        btnEdit.onclick = () => editKaufvertrag(i);
        cell.appendChild(btnEdit);
        sumVerbindlichkeiten += ekTotal;
      });
    }
  });

  document.getElementById('verbindlichkeitenSumme').innerText = `Gesamte offene Verbindlichkeiten: ${sumVerbindlichkeiten.toFixed(2)} €`;
}

</script>

</body>
</html>