<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Warenwirtschaft - Casa Divani</title>

<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<!-- Supabase Client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --primary-color: #4CAF50;
  --secondary-color: #2196F3;
  --accent-color: #FFC107;
  --delete-color: #F44336;
  --text-color: #333;
  --bg-color: #f4f6f8;
  --card-bg: #fff;
  --shadow: 0 4px 12px rgba(0,0,0,0.1);
  --border-radius: 8px;
  --transition: all 0.3s ease;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Roboto', sans-serif; background: var(--bg-color); color: var(--text-color); line-height: 1.5; font-size: 13px; }

h1 {
  margin-bottom: 20px;
  color: #222;
  font-size: 32px;
  font-weight: 500;
  position: relative;
  padding-right: 100px;
  line-height: 80px;
}
h1 img {
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  height: 80px;
  border-radius: 50%;
  box-shadow: var(--shadow);
}

h2 { margin-top: 30px; margin-bottom: 10px; color: #222; font-weight: 500; }
.container { width: 95%; max-width: 1600px; margin: auto; padding: 20px; }
.section { background: var(--card-bg); padding: 24px; margin-bottom: 24px; border-radius: var(--border-radius); box-shadow: var(--shadow); overflow-x: auto; transition: var(--transition); min-width: 0; }
.section:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.12); }

input, select, textarea { 
  padding: 10px; 
  margin: 6px 0; 
  border-radius: 6px; 
  border: 1px solid #ddd; 
  font-size: 14px; 
  transition: var(--transition); 
  width: 100%;
}
input:focus, select:focus, textarea:focus { 
  border-color: var(--primary-color); 
  box-shadow: 0 0 0 2px rgba(76,175,80,0.15); 
}

button { 
  background-color: var(--primary-color); 
  color: #fff; 
  border: none; 
  cursor: pointer; 
  font-weight: 500; 
}
button:hover { 
  background-color: #45a049; 
  transform: translateY(-1px); 
}

table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 12px; table-layout: fixed; }
th, td { border: 1px solid #e0e0e0; padding: 8px 6px; text-align: left; overflow: hidden; text-overflow: ellipsis; font-size: 12px; }
th { background-color: #f8f9fa; font-weight: 500; }

#lagerTabelle th:nth-child(1), #lagerTabelle td:nth-child(1) { width: 8%; }
#lagerTabelle th:nth-child(2), #lagerTabelle td:nth-child(2) { width: 12%; }
#lagerTabelle th:nth-child(3), #lagerTabelle td:nth-child(3) { width: 12%; }
#lagerTabelle th:nth-child(4), #lagerTabelle td:nth-child(4) { width: 8%; }
#lagerTabelle th:nth-child(5), #lagerTabelle td:nth-child(5) { width: 8%; }
#lagerTabelle th:nth-child(6), #lagerTabelle td:nth-child(6) { width: 6%; }
#lagerTabelle th:nth-child(7), #lagerTabelle td:nth-child(7) { width: 7%; }
#lagerTabelle th:nth-child(8), #lagerTabelle td:nth-child(8) { width: 7%; }
#lagerTabelle th:nth-child(9), #lagerTabelle td:nth-child(9) { width: 7%; }
#lagerTabelle th:nth-child(10), #lagerTabelle td:nth-child(10) { width: 5%; }
#lagerTabelle th:nth-child(11), #lagerTabelle td:nth-child(11) { width: 6%; }
#lagerTabelle th:nth-child(12), #lagerTabelle td:nth-child(12) { width: 7%; }
#lagerTabelle th:nth-child(13), #lagerTabelle td:nth-child(13) { width: 10%; }
#lagerTabelle th:nth-child(14), #lagerTabelle td:nth-child(14) { width: 7%; }

tr:nth-child(even) { background-color: #fafafa; }
tr:hover { background-color: #f1f1f1; }
tr.complete { background-color: #e8f5e9; }

.btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; transition: var(--transition); font-size: 12px; }
.btn-edit { background-color: var(--accent-color); color: white; } .btn-edit:hover { background-color: #e0a800; }
.btn-delete { background-color: var(--delete-color); color: white; } .btn-delete:hover { background-color: #d32f2f; }
.btn-verkaufen { background-color: var(--secondary-color); color: white; } .btn-verkaufen:hover { background-color: #0b7dda; }
.btn-pdf { background-color: #607D8B; color: white; margin-right: 5px; } .btn-pdf:hover { background-color: #455A64; }
.btn-add { background-color: var(--primary-color); color: white; font-size: 16px; padding: 12px 24px; margin-bottom: 16px; }

.btn-large {
  background-color: var(--primary-color);
  color: white;
  font-size: 18px;
  font-weight: 500;
  padding: 16px 32px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  display: block;
  width: 100%;
  max-width: 500px;
  margin: 20px auto 0 auto;
  text-align: center;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transition: var(--transition);
}

.btn-large:hover {
  background-color: #45a049;
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

 .btn-primary {
  background-color: var(--primary-color);
  color: white;
  font-size: 16px;
  font-weight: 500;
  padding: 12px 24px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  transition: var(--transition);
  margin-top: 20px;
  display: block;
  width: 100%;
  max-width: 300px;
  margin-left: auto;
  margin-right: auto;
}

.btn-primary:hover {
  background-color: #45a049;
  transform: translateY(-1px);
} 
  
@media (max-width: 768px) {
  .btn-large {
    font-size: 20px;
    padding: 18px 36px;
  }
}

.search-input { margin-bottom: 12px; width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd; }

/* Tabs – normal nebeneinander, nur auf Mobile untereinander */
.tab { 
  display: inline-block; 
  padding: 12px 24px; 
  background: #e0e0e0; 
  cursor: pointer; 
  border-radius: 6px 6px 0 0; 
  margin-right: 6px; 
  font-weight: 500; 
  transition: var(--transition); 
}
.tab.active { background: var(--primary-color); color: white; }
.tab:hover { background: #d0d0d0; }

.tab-content { display: none; }
.tab-content.active { display: block; }

.modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.55); align-items: center; justify-content: center; }
.modal-content { 
  background: var(--card-bg); 
  margin: auto; 
  padding: 32px; 
  width: 600px; 
  max-width: 95%; 
  max-height: 90vh; /* Wichtig: max-height für Scroll */
  overflow-y: auto; /* Scrollbar bei zu viel Inhalt */
  border-radius: 12px; 
  box-shadow: var(--shadow); 
  position: relative; 
}
.modal-content h2 { margin-bottom: 24px; font-size: 24px; color: #222; font-weight: 500; }
.modal-content label { display: block; font-size: 14px; font-weight: 500; color: #555; margin: 12px 0 4px; }
.modal-content input, .modal-content select { width: 100%; }
.close { position: absolute; right: 24px; top: 20px; font-size: 28px; cursor: pointer; color: #999; transition: var(--transition); }
.close:hover { color: #000; }

/* Responsive – nur auf kleinen Geräten anpassen */
@media (max-width: 992px) {
  .tab { 
    display: block; 
    width: 100%; 
    margin-right: 0; 
    margin-bottom: 8px; 
    border-radius: 6px; 
  }

  .btn, button { 
    padding: 10px 14px; 
    font-size: 14px; 
  }

  .section { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  table { min-width: 900px; }
}

@media (max-width: 600px) {
  h1 { font-size: 26px; padding-right: 80px; line-height: 70px; }
  h1 img { height: 60px; }
  h2 { font-size: 20px; }
  body { font-size: 14px; }
  th, td { font-size: 11px; padding: 6px 4px; }
}

  @media (max-width: 768px) {
  .modal-content {
    padding: 20px;
    max-height: 85vh;
  }
}
  
</style>
</head>
<body>

<!-- LOGIN MODAL (Supabase Auth) -->
<div id="loginModal" class="modal" style="display: flex; z-index:9999;">
  <div class="modal-content">
    <h2>Casa Divani Warenwirtschaft</h2>
    <p>Login für Mitarbeiter</p>
    <input type="email" id="loginEmail" placeholder="E-Mail" required>
    <input type="password" id="loginPass" placeholder="Passwort" required>
    <button class="btn-large" onclick="login()">Anmelden</button>
    <p id="authError" style="color:red;margin-top:10px;"></p>
    <p style="margin-top:20px; font-size:12px; color:#555;">Neue Mitarbeiter werden vom Admin angelegt.</p>
  </div>
</div>

<div class="container">
  <h1>Warenwirtschaft - Casa Divani
    <img src="https://i.imgur.com/o8Lowx7.png" alt="Casa Divani Logo">
  </h1>

  <div>
    <div class="tab active" onclick="switchTab('artikelTab')">Artikelverwaltung</div>
    <div class="tab" onclick="switchTab('verkaufTab')">Kaufvertrag</div>
    <div class="tab" onclick="switchTab('archivTab')">Archiv</div>
    <div class="tab" onclick="switchTab('steuerTab')">Steuerbericht</div>
    <div class="tab" onclick="switchTab('umsatzTab')">Umsatzübersicht</div>
    <div class="tab" onclick="switchTab('forderungenTab')">Forderungen/Verbindlichkeiten</div>
  </div>

  <!-- Artikelverwaltung -->
  <div id="artikelTab" class="tab-content active section">
    <h2>Artikel erfassen / Lager</h2>
    <button class="btn btn-add" onclick="openArtikelAddModal()">+ Artikel hinzufügen</button>

    <input type="text" class="search-input" id="lagerSuche" placeholder="Suche Lager..." onkeyup="filterLager()">
    <table id="lagerTabelle">
      <tr><th>Nr.</th><th>Name</th><th>Beschreibung</th><th>AuftragsNr.</th><th>Wareneingang</th><th>Herkunft</th><th>EK brutto</th><th>VK brutto</th><th>Marge Faktor</th><th>Menge</th><th>Steuer %</th><th>In Ausstellung</th><th>Aktionen</th><th>Bezahlt</th></tr>
    </table>
  </div>

  <!-- Kaufvertrag -->
  <div id="verkaufTab" class="tab-content section">
    <h2>Kaufvertrag / Verkauf</h2>
    <input type="text" class="search-input" id="verkaufSuche" placeholder="Suche Artikel..." onkeyup="updateVerkaufTabelle()">
    <table id="verkaufTabelle">
      <tr><th>Artikelname</th><th>Artikelnummer</th><th>Beschreibung</th><th>VK brutto</th><th>Menge</th><th>MwSt €</th><th>Aktion</th></tr>
    </table>

    <h3>Aktuelle Kaufvertragsartikel:</h3>
    <table id="aktuelleKaufvertragTabelle">
      <tr><th>Artikelname</th><th>Artikelnummer</th><th>Beschreibung</th><th>Menge</th><th>VK brutto</th><th>MwSt €</th><th>Aktion</th></tr>
    </table>

    <button class="btn-large" onclick="openKundeModal()">Kundendaten erfassen & Kaufvertrag abschließen</button>
  </div>

  <!-- Archiv -->
  <div id="archivTab" class="tab-content section">
    <h2>Archivierte Kaufverträge</h2>
    <input type="text" class="search-input" id="archivSuche" placeholder="Suche Archiv..." onkeyup="updateArchivTabelle()">
    <table id="archivTabelle">
      <tr><th>Kaufvertragsnummer</th><th>Kunde</th><th>Datum</th><th>Gesamtbetrag</th><th>Anzahlung</th><th>Restbetrag</th><th>Auftragsbestätigungsnummer</th><th>Ausgeliefert</th><th>Abgerechnet</th><th>Herstellerverbindlichkeiten bezahlt</th><th>Aktionen</th></tr>
    </table>
  </div>

  <!-- Steuerbericht -->
  <div id="steuerTab" class="tab-content section">
    <h2>Steuerbericht</h2>
    <div style="margin-bottom: 20px;">
      <label for="steuerJahrFilter" style="display: inline-block; width: 120px; font-weight: bold;">Jahr filtern:</label>
      <select id="steuerJahrFilter" onchange="updateSteuerTabelle()" style="display: inline-block; width: auto; padding: 8px; font-size: 14px; border-radius: 6px; border: 1px solid #ddd;">
        <option value="">Alle Jahre</option>
      </select>
    </div>
    <table id="steuerTabelle">
      <tr><th>Kaufvertragsnummer</th><th>Artikel</th><th>Menge</th><th>VK brutto</th><th>EK brutto</th><th>Umsatzsteuer €</th><th>Vorsteuer €</th><th>Steuerlast €</th></tr>
    </table>
    <p id="steuerSumme" style="margin-top:10px;font-weight:bold;"></p>
    <button class="btn-large" onclick="downloadSteuerPDF()">PDF Steuerbericht herunterladen</button>
  </div>

  <!-- Umsatzübersicht -->
  <div id="umsatzTab" class="tab-content section">
    <h2>Umsatzübersicht</h2>
    <div style="margin-bottom: 20px;">
      <label for="umsatzJahrFilter" style="display: inline-block; width: 120px; font-weight: bold;">Jahr filtern:</label>
      <select id="umsatzJahrFilter" onchange="updateUmsatzTabelle()" style="display: inline-block; width: auto; padding: 8px; font-size: 14px; border-radius: 6px; border: 1px solid #ddd;">
        <option value="">Alle Jahre</option>
      </select>
    </div>
    <table id="umsatzTabelle">
      <tr><th>Kaufvertragsnummer</th><th>Artikel</th><th>VK brutto €</th><th>EK brutto €</th><th>Reingewinn €</th></tr>
    </table>
    <p id="umsatzSumme" style="margin-top:10px;font-weight:bold;"></p>
  </div>

  <!-- Forderungen/Verbindlichkeiten -->
  <div id="forderungenTab" class="tab-content section">
    <h2>Forderungen/Verbindlichkeiten</h2>
    <h3>Offene Forderungen</h3>
    <table id="forderungenTabelle">
      <tr><th>Kaufvertragsnummer</th><th>Kunde</th><th>Restbetrag €</th><th>Bezahlt</th><th>Aktionen</th></tr>
    </table>
    <p id="forderungenSumme" style="margin-top:10px;font-weight:bold;"></p>

    <h3>Offene Verbindlichkeiten</h3>
    <table id="verbindlichkeitenTabelle">
      <tr><th>Kaufvertragsnummer</th><th>Artikelnummer</th><th>Name</th><th>AuftragsNr.</th><th>EK brutto €</th><th>Bezahlt</th><th>Aktionen</th></tr>
    </table>
    <p id="verbindlichkeitenSumme" style="margin-top:10px;font-weight:bold;"></p>
  </div>

  <!-- Artikel Hinzufügen Modal -->
  <div id="artikelAddModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeArtikelAddModal()">&times;</span>
      <h2>Artikel hinzufügen</h2>
      <label for="addArtikelNummer">Artikelnummer (z. B. CD123456-01 oder CD123456-XX)</label>
      <input id="addArtikelNummer" type="text" placeholder="CD123456-01">
      <label for="addArtikelName">Artikelname</label>
      <input id="addArtikelName" type="text">
      <label for="addArtikelBeschreibung">Beschreibung (Enter für Zeilenumbruch)</label>
      <textarea id="addArtikelBeschreibung" rows="8" placeholder="Hier kannst du mehrere Zeilen schreiben..."></textarea>
      <label for="addArtikelAuftragsNummer">Auftragsnummer</label>
      <input id="addArtikelAuftragsNummer" type="text">
      <label for="addArtikelWareneingang">Wareneingang (Datum)</label>
      <input id="addArtikelWareneingang" type="date">
      <label>Herkunft:</label>
      <label><input type="checkbox" id="addArtikelLager"> L (Lager)</label>
      <label><input type="checkbox" id="addArtikelKommission"> B (Kommissions Bestellung)</label>
      <label for="addArtikelEK">Einkaufspreis brutto (inkl. Vorsteuer)</label>
      <input id="addArtikelEK" type="number" step="0.01">
      <label for="addArtikelVK">Verkaufspreis brutto (inkl. MwSt)</label>
      <input id="addArtikelVK" type="number" step="0.01">
      <label for="addArtikelMenge">Menge</label>
      <input id="addArtikelMenge" type="number">
      <label for="addArtikelSteuer">Steuersatz (%)</label>
      <input id="addArtikelSteuer" type="number" value="19">
      <label><input type="checkbox" id="addArtikelInAusstellung"> In Ausstellung</label>
      <label for="addArtikelBezahlt">Bezahlt (Datum)</label>
      <input id="addArtikelBezahlt" type="date">
      <button class="btn btn-primary" onclick="artikelHinzufuegenFromModal()">Hinzufügen</button>
    </div>
  </div>

  <!-- Artikel Bearbeiten Modal -->
  <div id="artikelEditModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="document.getElementById('artikelEditModal').style.display='none'">&times;</span>
      <h2>Artikel bearbeiten</h2>
      <label for="editArtikelNummer">Artikelnummer</label>
      <input id="editArtikelNummer" type="text">
      <label for="editArtikelName">Artikelname</label>
      <input id="editArtikelName" type="text">
      <label for="editArtikelBeschreibung">Beschreibung (Enter für Zeilenumbruch)</label>
      <textarea id="editArtikelBeschreibung" rows="8"></textarea>
      <label for="editArtikelAuftragsNummer">Auftragsnummer</label>
      <input id="editArtikelAuftragsNummer" type="text">
      <label for="editArtikelWareneingang">Wareneingang (Datum)</label>
      <input id="editArtikelWareneingang" type="date">
      <label>Herkunft:</label>
      <label><input type="checkbox" id="editArtikelLager"> L (Lager)</label>
      <label><input type="checkbox" id="editArtikelKommission"> B (Kommissions Bestellung)</label>
      <label for="editArtikelEK">Einkaufspreis brutto (inkl. Vorsteuer)</label>
      <input id="editArtikelEK" type="number" step="0.01">
      <label for="editArtikelVK">Verkaufspreis brutto (inkl. MwSt)</label>
      <input id="editArtikelVK" type="number" step="0.01">
      <label for="editArtikelMenge">Menge</label>
      <input id="editArtikelMenge" type="number">
      <label for="editArtikelSteuer">Steuersatz (%)</label>
      <input id="editArtikelSteuer" type="number">
      <label><input type="checkbox" id="editArtikelInAusstellung"> In Ausstellung</label>
      <label for="editArtikelBezahlt">Bezahlt (Datum)</label>
      <input id="editArtikelBezahlt" type="date">
      <button class="btn btn-primary" onclick="artikelAenderungSpeichern()">Änderung speichern</button>
    </div>
  </div>

  <!-- Kundendaten Modal -->
  <div id="kundeModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeKundeModal()">&times;</span>
      <h3>Kundendaten & Zahlung</h3>
      <input type="text" id="kundeVorname" placeholder="Vorname">
      <input type="text" id="kundeNachname" placeholder="Nachname">
      <input type="text" id="kundeStrasse" placeholder="Straße">
      <input type="text" id="kundePLZ" placeholder="PLZ">
      <input type="text" id="kundeRuf" placeholder="Rufnummer">
      <input type="email" id="kundeEmail" placeholder="E-Mail">
      <input type="number" id="kundeAnzahlung" placeholder="Anzahlung" step="0.01">
      <select id="kundeZahlungsart" onchange="toggleUeberweisungDatum()">
        <option value="Bar">Bar</option>
        <option value="EC/Kreditkarte">EC/Kreditkarte</option>
        <option value="Überweisung">Überweisung</option>
      </select>
      <input type="date" id="ueberweisungsDatum" style="display:none;">
      <button class="btn-large" onclick="saveKaufvertrag()">Speichern & Kaufvertrag abschließen</button>
    </div>
  </div>

  <!-- Kaufvertrag Bearbeiten Modal -->
  <div id="kaufvertragEditModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="document.getElementById('kaufvertragEditModal').style.display='none'">&times;</span>
      <h2>Kaufvertrag bearbeiten</h2>
      <h3>Kundendaten bearbeiten</h3>
      <label for="editKundeVorname">Vorname</label>
      <input id="editKundeVorname" type="text">
      <label for="editKundeNachname">Nachname</label>
      <input id="editKundeNachname" type="text">
      <label for="editKundeStrasse">Straße</label>
      <input id="editKundeStrasse" type="text">
      <label for="editKundePLZ">PLZ</label>
      <input id="editKundePLZ" type="text">
      <label for="editKundeRuf">Rufnummer</label>
      <input id="editKundeRuf" type="text">
      <label for="editKundeEmail">E-Mail</label>
      <input id="editKundeEmail" type="email">

      <label for="editAusgeliefert">Ausgeliefert Datum</label>
      <input id="editAusgeliefert" type="date">
      <label for="editAbgerechnet">Abgerechnet Datum</label>
      <input id="editAbgerechnet" type="date">
      <label for="editHerstellerBezahlt">Herstellerverbindlichkeiten bezahlt (Datum)</label>
      <input id="editHerstellerBezahlt" type="date">
      <label for="editAuftragsNummer">Auftragsbestätigungsnummer</label>
      <input id="editAuftragsNummer" type="text">
      <h3>Artikel bearbeiten</h3>
      <table id="editArtikelTabelle">
        <tr><th>Artikelname</th><th>Artikelnummer</th><th>Beschreibung</th><th>EK brutto</th><th>VK brutto</th><th>Aktionen</th></tr>
      </table>
      <button class="btn btn-primary" onclick="kaufvertragAenderungSpeichern()">Änderung speichern</button>
    </div>
  </div>

  <!-- Artikel in Kaufvertrag bearbeiten Modal -->
  <div id="artikelInKaufvertragEditModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="document.getElementById('artikelInKaufvertragEditModal').style.display='none'">&times;</span>
      <h2>Artikel im Kaufvertrag bearbeiten</h2>
      <label for="editArtikelInKaufvertragName">Artikelname</label>
      <input id="editArtikelInKaufvertragName" type="text">
      <label for="editArtikelInKaufvertragNummer">Artikelnummer</label>
      <input id="editArtikelInKaufvertragNummer" type="text">
      <label for="editArtikelInKaufvertragBeschreibung">Beschreibung</label>
      <input id="editArtikelInKaufvertragBeschreibung" type="text">
      <label for="editArtikelInKaufvertragEK">EK brutto</label>
      <input id="editArtikelInKaufvertragEK" type="number" step="0.01">
      <label for="editArtikelInKaufvertragVK">VK brutto</label>
      <input id="editArtikelInKaufvertragVK" type="number" step="0.01">
      <button class="btn btn-primary" onclick="artikelInKaufvertragAenderungSpeichern()">Änderung speichern</button>
    </div>
  </div>

</div>

<script>
// Supabase Initialisierung
const supabaseUrl = 'https://lkwtwlqehgytdeyytgmr.supabase.co'
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxrd3R3bHFlaGd5dGRleXl0Z21yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNzg1OTcsImV4cCI6MjA4MTY1NDU5N30.Ie-aFVbgB_bfcCh5fQlNZIuXs5JffzxKemZiFi0ckI8'

const { createClient } = supabase
const supabaseClient = createClient(supabaseUrl, supabaseAnonKey)

// Globale Variablen
let lager = [];
let archiv = [];
let aktuelleKaufvertragArtikel = [];
let aktuellBearbeitenArchivIndex = null;
let aktuellBearbeitenArtikelIndex = null;
let aktuellBearbeitenIndex = null;

// Auth
async function login() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPass').value;
  if (!email || !password) {
    document.getElementById('authError').innerText = "Bitte E-Mail und Passwort eingeben.";
    return;
  }
  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if (error) {
    document.getElementById('authError').innerText = error.message;
  } else {
    document.getElementById('loginModal').style.display = 'none';
    initApp();
  }
}

// App initialisieren
async function initApp() {
  await loadLager();
  await loadArchiv();
  subscribeRealtime();
}

// Realtime abonnieren – stabil mit Fallback
async function subscribeRealtime() {
  await supabaseClient.removeAllChannels();

  supabaseClient.channel('lager-realtime')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'lager' }, () => loadLager())
    .subscribe();

  supabaseClient.channel('archiv-realtime')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'archiv' }, () => loadArchiv())
    .subscribe();

  supabaseClient.channel('archiv_artikel-realtime')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'archiv_artikel' }, () => loadArchiv())
    .subscribe();

  // Fallback: Alle 15 Sekunden neu laden
  setInterval(async () => {
    await loadLager();
    await loadArchiv();
  }, 15000);
}

// Daten laden
async function loadLager() {
  const { data, error } = await supabaseClient.from('lager').select('*').order('id', { ascending: false });
  if (error) console.error(error);
  else {
    lager = data || [];
    filterLager();
    updateVerkaufTabelle();
  }
}

async function loadArchiv() {
  const { data: archivData, error: archivError } = await supabaseClient.from('archiv').select('*').order('id', { ascending: false });
  if (archivError) console.error(archivError);
  else archiv = archivData || [];

  const { data: artikelData, error: artikelError } = await supabaseClient.from('archiv_artikel').select('*');
  if (artikelError) console.error(artikelError);
  else {
    archiv.forEach(k => k.artikel = artikelData.filter(a => a.archiv_id === k.id) || []);
  }

  updateArchivTabelle();
  updateSteuerTabelle();
  updateUmsatzTabelle();
  updateForderungenVerbindlichkeiten();
}

// Hilfsfunktion MwSt
function mwstAusBrutto(brutto, steuersatz) {
  return brutto * steuersatz / (100 + steuersatz);
}

// Tabs
function switchTab(tabId) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
  document.getElementById(tabId).classList.add('active');
}

// Artikelverwaltung
function openArtikelAddModal() {
  document.getElementById('artikelAddModal').style.display = 'flex';
}

function closeArtikelAddModal() {
  document.getElementById('artikelAddModal').style.display = 'none';
}

async function artikelHinzufuegenFromModal() {
  const artikelnummerInput = document.getElementById('addArtikelNummer').value.trim().toUpperCase();

  // Format-Prüfung: CD + 6 Ziffern + -00 bis -99 oder -XX
  const regex = /^CD\d{6}-(\d{2}|XX)$/;
  if (!regex.test(artikelnummerInput)) {
    alert('Ungültige Artikelnummer!\nMuss sein: CD + 6 Ziffern + -00 bis -99 oder -XX\nBeispiel: CD100100-01 oder CD100100-XX');
    return;
  }

  const endung = artikelnummerInput.slice(-2); // -01 oder -XX

  // Duplikat-Prüfung: Komplette Nummer darf nicht doppelt (außer -XX)
  const duplikat = lager.some(a => {
    if (endung === 'XX') return false; // -XX darf mehrmals
    return a.artikelnummer === artikelnummerInput;
  });

  if (duplikat) {
    alert('Diese Artikelnummer existiert bereits!\nJede Nummer (außer -XX) muss einzigartig sein.');
    return;
  }

    const herkunft_b = document.getElementById('addArtikelKommission').checked;
  const wareneingang = document.getElementById('addArtikelWareneingang').value || null;

  // Wareneingang nur verlangen, wenn NICHT Kommission/Bestellung
  if (!herkunft_b && !wareneingang) {
    alert('Wareneingang-Datum ist erforderlich, wenn Herkunft nicht "B (Kommissions Bestellung)" ist.');
    return;
  }

  const newArtikel = {
    artikelnummer: artikelnummerInput,
    name: document.getElementById('addArtikelName').value.trim(),
    beschreibung: document.getElementById('addArtikelBeschreibung').value.trim(),
    auftragsnummer: document.getElementById('addArtikelAuftragsNummer').value.trim(),
    wareneingang: wareneingang,
    herkunft_l: document.getElementById('addArtikelLager').checked,
    herkunft_b: herkunft_b,
    ek: parseFloat(document.getElementById('addArtikelEK').value),
    vk: parseFloat(document.getElementById('addArtikelVK').value),
    menge: parseInt(document.getElementById('addArtikelMenge').value),
    steuer: parseInt(document.getElementById('addArtikelSteuer').value),
    in_ausstellung: document.getElementById('addArtikelInAusstellung').checked,
    bezahlt: document.getElementById('addArtikelBezahlt').value || null
  };

  const { error } = await supabaseClient.from('lager').insert([newArtikel]);
  if (error) {
    alert('Fehler beim Speichern: ' + error.message);
  } else {
    await loadLager();
    await updateForderungenVerbindlichkeiten();
      // Felder leeren nach Speichern
  document.getElementById('addArtikelNummer').value = '';
  document.getElementById('addArtikelName').value = '';
  document.getElementById('addArtikelBeschreibung').value = '';
  document.getElementById('addArtikelAuftragsNummer').value = '';
  document.getElementById('addArtikelWareneingang').value = '';
  document.getElementById('addArtikelLager').checked = false;
  document.getElementById('addArtikelKommission').checked = false;
  document.getElementById('addArtikelEK').value = '';
  document.getElementById('addArtikelVK').value = '';
  document.getElementById('addArtikelMenge').value = '';
  document.getElementById('addArtikelSteuer').value = '19';
  document.getElementById('addArtikelInAusstellung').checked = false;
  document.getElementById('addArtikelBezahlt').value = '';
  }
  closeArtikelAddModal();
}
  
function editArtikel(index) {
  const a = lager[index];
  aktuellBearbeitenIndex = index;
  document.getElementById('editArtikelNummer').value = a.artikelnummer;
  document.getElementById('editArtikelName').value = a.name;
  document.getElementById('editArtikelBeschreibung').value = a.beschreibung;
  document.getElementById('editArtikelAuftragsNummer').value = a.auftragsnummer;
  document.getElementById('editArtikelWareneingang').value = a.wareneingang || '';
  document.getElementById('editArtikelLager').checked = a.herkunft_l;
  document.getElementById('editArtikelKommission').checked = a.herkunft_b;
  document.getElementById('editArtikelEK').value = a.ek;
  document.getElementById('editArtikelVK').value = a.vk;
  document.getElementById('editArtikelMenge').value = a.menge;
  document.getElementById('editArtikelSteuer').value = a.steuer;
  document.getElementById('editArtikelInAusstellung').checked = a.in_ausstellung;
  document.getElementById('editArtikelBezahlt').value = a.bezahlt || '';
  document.getElementById('artikelEditModal').style.display = 'flex';
}

async function artikelAenderungSpeichern() {
  if (aktuellBearbeitenIndex === null) return;
  const aktuellerArtikel = lager[aktuellBearbeitenIndex];

  const updatedArtikelnummer = document.getElementById('editArtikelNummer').value.trim().toUpperCase();

  // Format-Prüfung
  const regex = /^CD\d{6}-(\d{2}|XX)$/;
  if (!regex.test(updatedArtikelnummer)) {
    alert('Ungültige Artikelnummer!\nMuss sein: CD + 6 Ziffern + -00 bis -99 oder -XX');
    return;
  }

  const endung = updatedArtikelnummer.slice(-2);

  // Duplikat-Prüfung (außer beim eigenen Artikel und außer bei -XX)
  const duplikat = lager.some(a => {
    if (endung === 'XX') return false; // -XX darf mehrmals
    return a.artikelnummer === updatedArtikelnummer && a.id !== aktuellerArtikel.id;
  });

  if (duplikat) {
    alert('Diese Artikelnummer existiert bereits!\nJede Nummer (außer -XX) muss einzigartig sein.');
    return;
  }

  // Wareneingang-Prüfung
  const herkunft_b = document.getElementById('editArtikelKommission').checked;
  const wareneingang = document.getElementById('editArtikelWareneingang').value || null;

  if (!herkunft_b && !wareneingang) {
    alert('Wareneingang-Datum ist erforderlich, wenn Herkunft nicht "B (Kommissions Bestellung)" ist.');
    return;
  }

  const bezahlt = document.getElementById('editArtikelBezahlt').value || null;

  const updatedArtikel = {
    artikelnummer: updatedArtikelnummer,
    name: document.getElementById('editArtikelName').value.trim(),
    beschreibung: document.getElementById('editArtikelBeschreibung').value.trim(),
    auftragsnummer: document.getElementById('editArtikelAuftragsNummer').value.trim(),
    wareneingang: wareneingang,
    herkunft_l: document.getElementById('editArtikelLager').checked,
    herkunft_b: herkunft_b,
    ek: parseFloat(document.getElementById('editArtikelEK').value),
    vk: parseFloat(document.getElementById('editArtikelVK').value),
    menge: parseInt(document.getElementById('editArtikelMenge').value),
    steuer: parseInt(document.getElementById('editArtikelSteuer').value),
    in_ausstellung: document.getElementById('editArtikelInAusstellung').checked,
    bezahlt: bezahlt
  };

  // Lager aktualisieren
  const { error: lagerError } = await supabaseClient.from('lager').update(updatedArtikel).eq('id', aktuellerArtikel.id);
  if (lagerError) {
    alert('Fehler beim Speichern im Lager: ' + lagerError.message);
    return;
  }

  // Wenn Bezahlt-Datum geändert → alle passenden Archiv-Einträge aktualisieren
  if (bezahlt !== aktuellerArtikel.bezahlt) { // Nur bei Änderung
    const { data: archivArtikel, error: findError } = await supabaseClient
      .from('archiv_artikel')
      .select('archiv_id')
      .eq('artikelnummer', updatedArtikelnummer);

    if (findError) {
      console.error('Fehler beim Suchen der Archiv-Einträge: ' + findError.message);
    } else if (archivArtikel && archivArtikel.length > 0) {
      const archivIds = archivArtikel.map(a => a.archiv_id);
      await supabaseClient.from('archiv')
        .update({ hersteller_bezahlt: bezahlt })
        .in('id', archivIds);
    }
  }

  await loadLager();
  await loadArchiv(); // Für Offene Verbindlichkeiten aktualisieren
  await updateForderungenVerbindlichkeiten();
  aktuellBearbeitenIndex = null;
  document.getElementById('artikelEditModal').style.display = 'none';
}

function isArtikelComplete(a) {
  return a.artikelnummer && a.name && a.beschreibung && a.auftragsnummer && a.wareneingang && (a.herkunft_l || a.herkunft_b) && a.ek && a.vk && a.menge && a.steuer && a.bezahlt;
}

function filterLager() {
  const filter = document.getElementById('lagerSuche').value.toLowerCase().trim();
  const terms = filter.split(/\s+/);
  const table = document.getElementById('lagerTabelle');
  table.innerHTML = `<tr><th>Nr.</th><th>Name</th><th>Beschreibung</th><th>AuftragsNr.</th><th>Wareneingang</th><th>Herkunft</th><th>EK brutto</th><th>VK brutto</th><th>Marge Faktor</th><th>Menge</th><th>Steuer %</th><th>In Ausstellung</th><th>Aktionen</th><th>Bezahlt</th></tr>`;

  lager.forEach((a, i) => {
    const text = (a.artikelnummer + ' ' + a.name + ' ' + a.beschreibung).toLowerCase();
    if (terms.every(term => text.includes(term))) {
      const herkunft = [];
      if (a.herkunft_l) herkunft.push('L');
      if (a.herkunft_b) herkunft.push('B');
      const herkunftText = herkunft.join(', ') || '-';

      const row = table.insertRow();
      if (isArtikelComplete(a)) row.classList.add('complete');
      row.insertCell(0).innerText = a.artikelnummer;
      row.insertCell(1).innerText = a.name;
      row.insertCell(2).innerText = a.beschreibung;
      row.insertCell(3).innerText = a.auftragsnummer;
      row.insertCell(4).innerText = a.wareneingang || '-';
      row.insertCell(5).innerText = herkunftText;
      row.insertCell(6).innerText = a.ek.toFixed(2);
      row.insertCell(7).innerText = a.vk.toFixed(2);
      row.insertCell(8).innerText = (a.vk / a.ek).toFixed(2);
      row.insertCell(9).innerText = a.menge;
      row.insertCell(10).innerText = a.steuer + '%';
      row.insertCell(11).innerText = a.in_ausstellung ? 'Ja' : 'Nein';

      const cell = row.insertCell(12);

      const btnEdit = document.createElement('button');
      btnEdit.className = 'btn btn-edit';
      btnEdit.innerText = 'Bearbeiten';
      btnEdit.onclick = () => editArtikel(i);

      const btnDel = document.createElement('button');
      btnDel.className = 'btn btn-delete';
      btnDel.innerText = 'Löschen';
      btnDel.onclick = async () => {
        const { error } = await supabaseClient.from('lager').delete().eq('id', a.id);
        if (error) alert('Fehler: ' + error.message);
        else await loadLager();
        await updateForderungenVerbindlichkeiten(); // Offene Verbindlichkeiten aktualisieren
      };

      const btnPreis = document.createElement('button');
      btnPreis.className = 'btn btn-pdf';
      btnPreis.innerText = 'Preisschild';
      btnPreis.onclick = () => downloadPreisschildPDF(a);

      cell.appendChild(btnEdit);
      cell.appendChild(btnDel);
      cell.appendChild(btnPreis);

      row.insertCell(13).innerText = a.bezahlt || '-';
    }
  });
}
// Kaufvertrag
function updateVerkaufTabelle() {
  const filter = document.getElementById('verkaufSuche').value.toLowerCase().trim();
  const terms = filter.split(/\s+/);
  const table = document.getElementById('verkaufTabelle');
  table.innerHTML = '<tr><th>Artikelname</th><th>Artikelnummer</th><th>Beschreibung</th><th>VK brutto</th><th>Menge</th><th>MwSt €</th><th>Aktion</th></tr>';
  lager.forEach((a, i) => {
    const text = (a.artikelnummer + ' ' + a.name + ' ' + a.beschreibung).toLowerCase();
    if (a.menge > 0 && terms.every(term => text.includes(term))) {
      const mwst = mwstAusBrutto(a.vk, a.steuer);
      const row = table.insertRow();
      row.insertCell(0).innerText = a.name;
      row.insertCell(1).innerText = a.artikelnummer;
      row.insertCell(2).innerText = a.beschreibung;
      row.insertCell(3).innerText = a.vk.toFixed(2);
      row.insertCell(4).innerText = a.menge;
      row.insertCell(5).innerText = mwst.toFixed(2);
      const cell = row.insertCell(6);
      const btn = document.createElement('button');
      btn.className = 'btn btn-verkaufen'; btn.innerText = 'Hinzufügen';
      btn.onclick = () => addToKaufvertrag(i);
      cell.appendChild(btn);
    }
  });
}

function addToKaufvertrag(index) {
  const artikel = { ...lager[index] }; // Kopie des Artikels
  aktuelleKaufvertragArtikel.push(artikel);

  // Menge im Lager reduzieren
  const neueMenge = artikel.menge - 1;

  if (neueMenge > 0) {
    // Nur Menge aktualisieren
    supabaseClient.from('lager').update({ menge: neueMenge }).eq('id', artikel.id).then(() => {
      loadLager(); // Neu laden für korrekte Anzeige
    });
  } else {
    // Artikel komplett löschen (Menge = 0)
    supabaseClient.from('lager').delete().eq('id', artikel.id).then(() => {
      loadLager();
    });
  }

  updateVerkaufTabelle();
  updateAktuelleKaufvertragTabelle();
}

function updateAktuelleKaufvertragTabelle() {
  const table = document.getElementById('aktuelleKaufvertragTabelle');
  table.innerHTML = '<tr><th>Artikelname</th><th>Artikelnummer</th><th>Beschreibung</th><th>Menge</th><th>VK brutto</th><th>MwSt €</th><th>Aktion</th></tr>';
  aktuelleKaufvertragArtikel.forEach((a, i) => {
    const mwst = mwstAusBrutto(a.vk, a.steuer);
    const row = table.insertRow();
    row.insertCell(0).innerText = a.name;
    row.insertCell(1).innerText = a.artikelnummer;
    row.insertCell(2).innerText = a.beschreibung;
    row.insertCell(3).innerText = 1;
    row.insertCell(4).innerText = a.vk.toFixed(2);
    row.insertCell(5).innerText = mwst.toFixed(2);
    const cell = row.insertCell(6);
    const btn = document.createElement('button');
    btn.className = 'btn btn-delete'; btn.innerText = 'Entfernen';
    btn.onclick = () => removeFromKaufvertrag(i);
    cell.appendChild(btn);
  });
}

function removeFromKaufvertrag(index) {
  const artikel = aktuelleKaufvertragArtikel[index];

  // Prüfen, ob Artikel bereits im Lager existiert
  const existierender = lager.find(a => a.artikelnummer === artikel.artikelnummer);

  if (existierender) {
    // Menge erhöhen
    const neueMenge = existierender.menge + 1;
    supabaseClient.from('lager').update({ menge: neueMenge }).eq('id', existierender.id).then(() => {
      loadLager();
    });
  } else {
    // Artikel neu anlegen (Menge = 1)
    const neuerArtikel = { ...artikel, menge: 1 };
    delete neuerArtikel.id; // ID nicht mitübernehmen
    supabaseClient.from('lager').insert([neuerArtikel]).then(() => {
      loadLager();
    });
  }

  aktuelleKaufvertragArtikel.splice(index, 1);
  updateVerkaufTabelle();
  updateAktuelleKaufvertragTabelle();
}

function openKundeModal() { document.getElementById('kundeModal').style.display = 'flex'; }
function closeKundeModal() { document.getElementById('kundeModal').style.display = 'none'; }
function toggleUeberweisungDatum() {
  const sel = document.getElementById('kundeZahlungsart').value;
  document.getElementById('ueberweisungsDatum').style.display = (sel === 'Überweisung') ? 'block' : 'none';
}

async function saveKaufvertrag() {
  if (aktuelleKaufvertragArtikel.length === 0) { 
    alert("Keine Artikel im Kaufvertrag!"); 
    return; 
  }
  const vorname = document.getElementById('kundeVorname').value.trim();
  const nachname = document.getElementById('kundeNachname').value.trim();
  if (!vorname || !nachname) { 
    alert("Bitte Kundendaten ausfüllen!"); 
    return; 
  }

  const kunde = {
    vorname, 
    nachname,
    strasse: document.getElementById('kundeStrasse').value,
    plz: document.getElementById('kundePLZ').value,
    ruf: document.getElementById('kundeRuf').value,
    email: document.getElementById('kundeEmail').value,
    anzahlung: parseFloat(document.getElementById('kundeAnzahlung').value) || 0,
    zahlungsart: document.getElementById('kundeZahlungsart').value,
    ueberweisungsDatum: document.getElementById('ueberweisungsDatum').value
  };

  const jahr = new Date().getFullYear();

  // Sichere Generierung der nächsten freien Kaufvertragsnummer
  let laufendeNr = 1;
  let kaufvertragsnummer = `CD${jahr}${String(laufendeNr).padStart(3, '0')}`;
  let exists = true;

  while (exists) {
    const { data: checkData, error: checkError } = await supabaseClient
      .from('archiv')
      .select('id')
      .eq('kaufvertragsnummer', kaufvertragsnummer)
      .maybeSingle();

    if (checkError && checkError.code !== 'PGRST116') { // PGRST116 = kein Ergebnis
      alert('Fehler beim Prüfen der Kaufvertragsnummer: ' + checkError.message);
      return;
    }

    if (checkData) {
      laufendeNr++;
      kaufvertragsnummer = `CD${jahr}${String(laufendeNr).padStart(3, '0')}`;
    } else {
      exists = false;
    }
  }

  let gesamt = 0;
  aktuelleKaufvertragArtikel.forEach(a => gesamt += a.vk);

  const originalRestbetrag = gesamt - kunde.anzahlung;

  const newArchiv = {
    kaufvertragsnummer,
    kunde_vorname: kunde.vorname,
    kunde_nachname: kunde.nachname,
    kunde_strasse: kunde.strasse,
    kunde_plz: kunde.plz,
    kunde_ruf: kunde.ruf,
    kunde_email: kunde.email,
    datum: new Date().toLocaleDateString('de-DE'),
    gesamtbetrag: gesamt,
    anzahlung: kunde.anzahlung,
    restbetrag: originalRestbetrag,
    ausgeliefert: null,
    abgerechnet: null,
    hersteller_bezahlt: null
  };

  const { data: archivData, error: archivError } = await supabaseClient.from('archiv').insert([newArchiv]).select();
  if (archivError) {
    alert('Fehler beim Speichern des Verkaufs: ' + archivError.message);
    return;
  }

  const archivId = archivData[0].id;

  const artikelForInsert = aktuelleKaufvertragArtikel.map(a => ({
    archiv_id: archivId,
    name: a.name,
    artikelnummer: a.artikelnummer,
    beschreibung: a.beschreibung,
    ek: a.ek,
    vk: a.vk,
    steuer: a.steuer,
    kommission_herkunft: a.herkunft_b
  }));

  const { error: artikelError } = await supabaseClient.from('archiv_artikel').insert(artikelForInsert);
  if (artikelError) alert('Fehler beim Speichern der Artikel: ' + artikelError.message);
  else await loadArchiv();

  aktuelleKaufvertragArtikel = [];
  updateAktuelleKaufvertragTabelle();
  closeKundeModal();
  ['kundeVorname', 'kundeNachname', 'kundeStrasse', 'kundePLZ', 'kundeRuf', 'kundeEmail', 'kundeAnzahlung', 'ueberweisungsDatum'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('kundeZahlungsart').value = 'Bar';
  toggleUeberweisungDatum();
  alert("Kaufvertrag abgeschlossen!");
}

// Archiv bearbeiten
function editKaufvertrag(index) {
  const k = archiv[index];
  aktuellBearbeitenArchivIndex = index;
  document.getElementById('editAusgeliefert').value = k.ausgeliefert || '';
  document.getElementById('editAbgerechnet').value = k.abgerechnet || '';
  document.getElementById('editHerstellerBezahlt').value = k.hersteller_bezahlt || '';
  document.getElementById('editAuftragsNummer').value = k.auftragsnummer || '';
    // Kundendaten befüllen
  document.getElementById('editKundeVorname').value = k.kunde_vorname || '';
  document.getElementById('editKundeNachname').value = k.kunde_nachname || '';
  document.getElementById('editKundeStrasse').value = k.kunde_strasse || '';
  document.getElementById('editKundePLZ').value = k.kunde_plz || '';
  document.getElementById('editKundeRuf').value = k.kunde_ruf || '';
  document.getElementById('editKundeEmail').value = k.kunde_email || '';
  const table = document.getElementById('editArtikelTabelle');
  table.innerHTML = '<tr><th>Artikelname</th><th>Artikelnummer</th><th>Beschreibung</th><th>EK brutto</th><th>VK brutto</th><th>Aktionen</th></tr>';
  k.artikel.forEach((a, j) => {
    const row = table.insertRow();
    row.insertCell(0).innerText = a.name;
    row.insertCell(1).innerText = a.artikelnummer;
    row.insertCell(2).innerText = a.beschreibung;
    row.insertCell(3).innerText = a.ek.toFixed(2);
    row.insertCell(4).innerText = a.vk.toFixed(2);
    const cell = row.insertCell(5);
    const btnEdit = document.createElement('button');
    btnEdit.className = 'btn btn-edit'; btnEdit.innerText = 'Bearbeiten';
    btnEdit.onclick = () => editArtikelInKaufvertrag(j);
    cell.appendChild(btnEdit);
  });
  document.getElementById('kaufvertragEditModal').style.display = 'flex';
}

function editArtikelInKaufvertrag(artikelIndex) {
  const k = archiv[aktuellBearbeitenArchivIndex];
  const a = k.artikel[artikelIndex];
  aktuellBearbeitenArtikelIndex = artikelIndex;
  document.getElementById('editArtikelInKaufvertragName').value = a.name;
  document.getElementById('editArtikelInKaufvertragNummer').value = a.artikelnummer;
  document.getElementById('editArtikelInKaufvertragBeschreibung').value = a.beschreibung;
  document.getElementById('editArtikelInKaufvertragEK').value = a.ek;
  document.getElementById('editArtikelInKaufvertragVK').value = a.vk;
  document.getElementById('artikelInKaufvertragEditModal').style.display = 'flex';
}

async function artikelInKaufvertragAenderungSpeichern() {
  if (aktuellBearbeitenArchivIndex === null || aktuellBearbeitenArtikelIndex === null) return;
  const k = archiv[aktuellBearbeitenArchivIndex];
  const a = k.artikel[aktuellBearbeitenArtikelIndex];
  const updated = {
    name: document.getElementById('editArtikelInKaufvertragName').value.trim(),
    artikelnummer: document.getElementById('editArtikelInKaufvertragNummer').value.trim(),
    beschreibung: document.getElementById('editArtikelInKaufvertragBeschreibung').value.trim(),
    ek: parseFloat(document.getElementById('editArtikelInKaufvertragEK').value),
    vk: parseFloat(document.getElementById('editArtikelInKaufvertragVK').value)
  };

  const { error } = await supabaseClient.from('archiv_artikel').update(updated).eq('id', a.id);
  if (error) alert('Fehler: ' + error.message);
  else await loadArchiv();
  aktuellBearbeitenArtikelIndex = null;
  document.getElementById('artikelInKaufvertragEditModal').style.display = 'none';
}

async function kaufvertragAenderungSpeichern() {
  if (aktuellBearbeitenArchivIndex === null) return;
  const k = archiv[aktuellBearbeitenArchivIndex];

  const abgerechnet = document.getElementById('editAbgerechnet').value || null;
  const hersteller_bezahlt = document.getElementById('editHerstellerBezahlt').value || null;
  const ausgeliefert = document.getElementById('editAusgeliefert').value || null;
  const auftragsnummer = document.getElementById('editAuftragsNummer').value.trim() || null;

    const updated = {
    ausgeliefert,
    abgerechnet,
    hersteller_bezahlt,
    auftragsnummer,
    kunde_vorname: document.getElementById('editKundeVorname').value.trim(),
    kunde_nachname: document.getElementById('editKundeNachname').value.trim(),
    kunde_strasse: document.getElementById('editKundeStrasse').value.trim(),
    kunde_plz: document.getElementById('editKundePLZ').value.trim(),
    kunde_ruf: document.getElementById('editKundeRuf').value.trim(),
    kunde_email: document.getElementById('editKundeEmail').value.trim()
  };

  // 1. Wenn abgerechnet gefüllt → Restbetrag auf 0 setzen
  if (abgerechnet && k.restbetrag > 0) {
    updated.restbetrag = 0;
    updated.anzahlung = k.gesamtbetrag; // Anzahlung = Gesamtbetrag (vollständig bezahlt)
  }

  // Speichern im Archiv
  const { error } = await supabaseClient.from('archiv').update(updated).eq('id', k.id);
  if (error) {
    alert('Fehler beim Speichern: ' + error.message);
    return;
  }

  // 2. Wenn Herstellerverbindlichkeiten bezahlt geändert → Lager "Bezahlt" aktualisieren
  if (hersteller_bezahlt !== k.hersteller_bezahlt) { // Nur bei Änderung
    const { data: artikelData, error: artikelError } = await supabaseClient
      .from('archiv_artikel')
      .select('artikelnummer')
      .eq('archiv_id', k.id);

    if (artikelError) {
      console.error('Fehler beim Laden der Artikelnummern: ' + artikelError.message);
    } else if (artikelData && artikelData.length > 0) {
      const artikelnummern = artikelData.map(a => a.artikelnummer);

      const { error: lagerError } = await supabaseClient
        .from('lager')
        .update({ bezahlt: hersteller_bezahlt })
        .in('artikelnummer', artikelnummern);

      if (lagerError) console.error('Fehler beim Aktualisieren der Lager-Artikel: ' + lagerError.message);
    }
  }

  await loadArchiv(); // Alles neu laden
  await loadLager(); // Für Offene Verbindlichkeiten
  await updateForderungenVerbindlichkeiten(); // Explizit aktualisieren

  aktuellBearbeitenArchivIndex = null;
  document.getElementById('kaufvertragEditModal').style.display = 'none';
}

// Archiv Tabelle
function updateArchivTabelle() {
  const filter = document.getElementById('archivSuche').value.toLowerCase().trim();
  const table = document.getElementById('archivTabelle');
  table.innerHTML = '<tr><th>Kaufvertragsnummer</th><th>Kunde</th><th>Datum</th><th>Gesamtbetrag</th><th>Anzahlung</th><th>Restbetrag</th><th>Auftragsbestätigungsnummer</th><th>Ausgeliefert</th><th>Abgerechnet</th><th>Herstellerverbindlichkeiten bezahlt</th><th>Aktionen</th></tr>';
  archiv.forEach((k, i) => {
    const text = (k.kaufvertragsnummer + ' ' + k.kunde_vorname + ' ' + k.kunde_nachname).toLowerCase();
    if (filter === '' || text.includes(filter)) {
      const row = table.insertRow();
      if (isArchivComplete(k)) row.classList.add('complete');
      row.insertCell(0).innerText = k.kaufvertragsnummer;
      row.insertCell(1).innerText = k.kunde_vorname + ' ' + k.kunde_nachname;
      row.insertCell(2).innerText = k.datum;
      row.insertCell(3).innerText = k.gesamtbetrag.toFixed(2);
      row.insertCell(4).innerText = k.anzahlung.toFixed(2);
      row.insertCell(5).innerText = k.restbetrag.toFixed(2);
      row.insertCell(6).innerText = k.auftragsnummer || '-';
      row.insertCell(7).innerText = k.ausgeliefert || '-';
      row.insertCell(8).innerText = k.abgerechnet || '-';
      row.insertCell(9).innerText = k.hersteller_bezahlt || '-';
      const cell = row.insertCell(10);
      const btnEdit = document.createElement('button');
      btnEdit.className = 'btn btn-edit'; btnEdit.innerText = 'Bearbeiten';
      btnEdit.onclick = () => editKaufvertrag(i);
      const btnDel = document.createElement('button');
      btnDel.className = 'btn btn-delete'; btnDel.innerText = 'Löschen';
      btnDel.onclick = async () => {
        if (!confirm('Kaufvertrag wirklich löschen? Die Artikel werden zurück ins Lager gelegt.')) return;

        // Zuerst archiv_artikel löschen
        const { error: artikelError } = await supabaseClient.from('archiv_artikel').delete().eq('archiv_id', k.id);
        if (artikelError) {
          alert('Fehler beim Löschen der Artikel: ' + artikelError.message);
          return;
        }

        // Dann archiv-Eintrag löschen
        const { error: archivError } = await supabaseClient.from('archiv').delete().eq('id', k.id);
        if (archivError) {
          alert('Fehler beim Löschen des Kaufvertrags: ' + archivError.message);
          return;
        }

        // Artikel zurück ins Lager legen
        k.artikel.forEach(a => {
          const exist = lager.find(l => l.artikelnummer === a.artikelnummer);
          if (exist) {
            supabaseClient.from('lager').update({ menge: exist.menge + 1 }).eq('id', exist.id);
          } else {
            const newLagerArtikel = {
              artikelnummer: a.artikelnummer,
              name: a.name,
              beschreibung: a.beschreibung,
              auftragsnummer: a.auftragsnummer || '',
              wareneingang: a.wareneingang || null,
              herkunft_l: a.herkunft_l || false,
              herkunft_b: a.herkunft_b || false,
              ek: a.ek,
              vk: a.vk,
              menge: 1,
              steuer: a.steuer,
              in_ausstellung: a.in_ausstellung || false,
              bezahlt: a.bezahlt || null
            };
            supabaseClient.from('lager').insert([newLagerArtikel]);
          }
        });

        await loadArchiv();
        await loadLager();
        await updateForderungenVerbindlichkeiten();
      };
      const btnPDF = document.createElement('button');
      btnPDF.className = 'btn btn-pdf'; btnPDF.innerText = 'Kaufvertrag PDF';
      btnPDF.onclick = () => downloadKaufvertragPDF(k);
      cell.appendChild(btnEdit);
      cell.appendChild(btnDel);
      cell.appendChild(btnPDF);
      if (k.artikel.some(a => a.kommission_herkunft)) {
        const btnHerstellerPDF = document.createElement('button');
        btnHerstellerPDF.className = 'btn btn-pdf'; btnHerstellerPDF.innerText = 'Herstellerbestellung PDF';
        btnHerstellerPDF.onclick = () => downloadHerstellerbestellungPDF(k);
        cell.appendChild(btnHerstellerPDF);
      }
    }
  });
}
  
function isArchivComplete(k) {
  return k.ausgeliefert && k.abgerechnet && k.hersteller_bezahlt;
}

// Steuerbericht
function updateSteuerTabelle() {
  const selectedYear = document.getElementById('steuerJahrFilter').value;
  const table = document.getElementById('steuerTabelle');
  table.innerHTML = `<tr><th>Kaufvertragsnummer</th><th>Artikel</th><th>Menge</th><th>VK brutto</th><th>EK brutto</th><th>Umsatzsteuer €</th><th>Vorsteuer €</th><th>Steuerlast €</th></tr>`;

  let gesamtSteuerlast = 0;

  // Alle Jahre sammeln und Dropdown aktualisieren
  const years = new Set();
  archiv.forEach(k => {
    const kYear = parseInt(k.datum.split('.')[2], 10);
    years.add(kYear);
  });

  const select = document.getElementById('steuerJahrFilter');
  select.innerHTML = '<option value="">Alle Jahre</option>';
  const sortedYears = Array.from(years).sort((a, b) => a - b);
  sortedYears.forEach(year => {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    select.appendChild(option);
  });

  if (selectedYear && sortedYears.includes(parseInt(selectedYear))) {
    select.value = selectedYear;
  }

  // Tabelle filtern
  archiv.forEach(k => {
    const kYear = parseInt(k.datum.split('.')[2], 10);
    if (!selectedYear || kYear == selectedYear) {
      k.artikel.forEach(a => {
        const ust = mwstAusBrutto(a.vk, a.steuer);
        const vst = mwstAusBrutto(a.ek, a.steuer);
        const steuerlast = ust - vst;

        const row = table.insertRow();
        row.insertCell(0).innerText = k.kaufvertragsnummer;
        row.insertCell(1).innerText = a.name;
        row.insertCell(2).innerText = '1';
        row.insertCell(3).innerText = a.vk.toFixed(2);
        row.insertCell(4).innerText = a.ek.toFixed(2);
        row.insertCell(5).innerText = ust.toFixed(2);
        row.insertCell(6).innerText = vst.toFixed(2);
        row.insertCell(7).innerText = steuerlast.toFixed(2);

        gesamtSteuerlast += steuerlast;
      });
    }
  });

  const jahrText = selectedYear ? selectedYear : 'alle Jahre';
  document.getElementById('steuerSumme').innerText = `Gesamte Steuerlast (${jahrText}): ${gesamtSteuerlast.toFixed(2)} €`;
}

// Umsatzübersicht
function updateUmsatzTabelle() {
  const selectedYear = document.getElementById('umsatzJahrFilter').value;
  const table = document.getElementById('umsatzTabelle');
  table.innerHTML = `<tr><th>Kaufvertragsnummer</th><th>Artikel</th><th>VK brutto €</th><th>EK brutto €</th><th>Reingewinn €</th></tr>`;

  let sumVK = 0, sumEK = 0, sumGewinn = 0;

  // Alle Jahre sammeln
  const years = new Set();
  archiv.forEach(k => {
    const kYear = parseInt(k.datum.split('.')[2], 10);
    years.add(kYear);
  });

  // Dropdown neu füllen
  const select = document.getElementById('umsatzJahrFilter');
  select.innerHTML = '<option value="">Alle Jahre</option>';
  const sortedYears = Array.from(years).sort((a, b) => a - b);
  sortedYears.forEach(year => {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    select.appendChild(option);
  });

  if (selectedYear && sortedYears.includes(parseInt(selectedYear))) {
    select.value = selectedYear;
  }

  // Tabelle filtern
  archiv.forEach(k => {
    const kYear = parseInt(k.datum.split('.')[2], 10);
    if (!selectedYear || kYear == selectedYear) {
      k.artikel.forEach(a => {
        const ust = mwstAusBrutto(a.vk, a.steuer);
        const vst = mwstAusBrutto(a.ek, a.steuer);
        const steuerlast = ust - vst;
        const gewinn = (a.vk - a.ek) - steuerlast;

        sumVK += a.vk;
        sumEK += a.ek;
        sumGewinn += gewinn;

        const row = table.insertRow();
        row.insertCell(0).innerText = k.kaufvertragsnummer;
        row.insertCell(1).innerText = a.name;
        row.insertCell(2).innerText = a.vk.toFixed(2);
        row.insertCell(3).innerText = a.ek.toFixed(2);
        row.insertCell(4).innerText = gewinn.toFixed(2);
      });
    }
  });

  const jahrText = selectedYear ? selectedYear : 'alle Jahre';
  document.getElementById('umsatzSumme').innerText = 
    `Gesamt VK brutto (${jahrText}): ${sumVK.toFixed(2)} € | Gesamt EK brutto: ${sumEK.toFixed(2)} € | Reingewinn: ${sumGewinn.toFixed(2)} €`;
}

// Forderungen/Verbindlichkeiten
function updateForderungenVerbindlichkeiten() {
  // Offene Forderungen (wie bisher)
  const forderungenTable = document.getElementById('forderungenTabelle');
  forderungenTable.innerHTML = '<tr><th>Kaufvertragsnummer</th><th>Kunde</th><th>Restbetrag €</th><th>Bezahlt</th><th>Aktionen</th></tr>';
  let sumForderungen = 0;

  archiv.forEach((k, i) => {
    if (k.restbetrag > 0) {
      const row = forderungenTable.insertRow();
      row.insertCell(0).innerText = k.kaufvertragsnummer;
      row.insertCell(1).innerText = k.kunde_vorname + ' ' + k.kunde_nachname;
      row.insertCell(2).innerText = k.restbetrag.toFixed(2);
      row.insertCell(3).innerText = k.abgerechnet || '-';
      const cell = row.insertCell(4);
      const btnEdit = document.createElement('button');
      btnEdit.className = 'btn btn-edit'; btnEdit.innerText = 'Bearbeiten';
      btnEdit.onclick = () => editKaufvertrag(i);
      cell.appendChild(btnEdit);
      sumForderungen += k.restbetrag;
    }
  });

  document.getElementById('forderungenSumme').innerText = `Gesamte offene Forderungen: ${sumForderungen.toFixed(2)} €`;

  // Offene Verbindlichkeiten (nur wenn Bezahlt leer)
  const verbindlichkeitenTable = document.getElementById('verbindlichkeitenTabelle');
  verbindlichkeitenTable.innerHTML = '<tr><th>Kaufvertragsnummer</th><th>Artikelnummer</th><th>Name</th><th>AuftragsNr.</th><th>EK brutto €</th><th>Bezahlt</th><th>Aktionen</th></tr>';
  let sumVerbindlichkeiten = 0;

  // Aus Archiv (kommission_herkunft = true und hersteller_bezahlt leer)
  archiv.forEach(k => {
    if (!k.hersteller_bezahlt) {
      k.artikel.forEach(a => {
        if (a.kommission_herkunft) {
          const row = verbindlichkeitenTable.insertRow();
          row.insertCell(0).innerText = k.kaufvertragsnummer;
          row.insertCell(1).innerText = a.artikelnummer;
          row.insertCell(2).innerText = a.name;
          row.insertCell(3).innerText = a.auftragsnummer || '-';
          row.insertCell(4).innerText = a.ek.toFixed(2);
          row.insertCell(5).innerText = k.hersteller_bezahlt || '-';
          sumVerbindlichkeiten += a.ek;
        }
      });
    }
  });

  // Aus Lager (Bezahlt leer)
  lager.forEach(a => {
    if (!a.bezahlt) {
      const row = verbindlichkeitenTable.insertRow();
      row.insertCell(0).innerText = '-'; // Kein Kaufvertrag
      row.insertCell(1).innerText = a.artikelnummer;
      row.insertCell(2).innerText = a.name;
      row.insertCell(3).innerText = a.auftragsnummer || '-';
      row.insertCell(4).innerText = a.ek.toFixed(2);
      row.insertCell(5).innerText = a.bezahlt || '-';
      sumVerbindlichkeiten += a.ek;
    }
  });

  document.getElementById('verbindlichkeitenSumme').innerText = `Gesamte offene Verbindlichkeiten: ${sumVerbindlichkeiten.toFixed(2)} €`;
}

// PDF-Funktionen (wie in deiner letzten Version – vollständig und korrigiert)
function downloadKaufvertragPDF(k) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const logoUrl = "https://i.imgur.com/o8Lowx7.png";
  const img = new Image();
  img.crossOrigin = "Anonymous";

  img.onload = function () {
    const today = new Date().toLocaleDateString('de-DE');

    // Header auf jeder Vertragsseite
    function addHeader() {
      doc.addImage(img, 'PNG', 170, 8, 30, 30);

      doc.setFontSize(16);
      doc.setFont(undefined, "bold");
      doc.text("Casa Divani", 20, 20);

      doc.setFontSize(10);
      doc.setFont(undefined, "normal");
      doc.text("Musterstrasse 1", 20, 28);
      doc.text("11111 Musterstadt", 20, 34);
      doc.text("Telefon: 01234-567890", 20, 40);
      doc.text("E-Mail: info@casadivani.de", 20, 46);

      // Datum und Nummer rechts, in separaten Zeilen
      doc.setFontSize(12);
      doc.setFont(undefined, "bold");
      doc.text(`Datum: ${today}`, 150, 28, { align: "right" });
      doc.text(`Kaufvertragsnummer: ${k.kaufvertragsnummer}`, 150, 36, { align: "right" });

      // Kunde
      doc.setFontSize(11);
      doc.setFont(undefined, "normal");
      doc.text(`Kunde: ${k.kunde_vorname} ${k.kunde_nachname}`, 20, 56);
      doc.text(`Adresse: ${k.kunde_strasse}`, 20, 62);
      doc.text(`${k.kunde_plz}`, 20, 68);
      if (k.kunde_email) doc.text(`E-Mail: ${k.kunde_email}`, 20, 74);
      if (k.kunde_ruf) doc.text(`Telefon: ${k.kunde_ruf}`, 20, 80);
    }

    addHeader(); // Header auf Seite 1

    // Artikel-Tabelle
    const artikelRows = k.artikel.map(a => [
      a.name,
      a.artikelnummer,
      a.beschreibung,
      '1',
      a.vk.toFixed(2),
      mwstAusBrutto(a.vk, a.steuer).toFixed(2)
    ]);

    doc.autoTable({
      head: [['Artikel', 'Nummer', 'Beschreibung', 'Menge', 'VK inkl. MwSt €', 'MwSt €']],
      body: artikelRows,
      startY: 90, // Mehr Platz für Header
      styles: { fontSize: 10, cellPadding: 3 },
      headStyles: { fillColor: [100, 100, 100], textColor: 255, fontStyle: 'bold' },
      alternateRowStyles: { fillColor: [240, 240, 240] },
      margin: { left: 20, right: 20 },
      pageBreak: 'auto',
      didDrawPage: (data) => {
        if (data.pageNumber > 1) addHeader(); // Header auf neuen Seiten
      }
    });

    // Zahlungsübersicht
    let yPos = doc.lastAutoTable.finalY + 20;

    doc.setFontSize(11);
    doc.setFont(undefined, "bold");
    doc.text("Zahlungsübersicht", 20, yPos);
    yPos += 10;

    doc.autoTable({
      startY: yPos,
      theme: 'grid',
      styles: { fontSize: 10, cellPadding: 3 },
      headStyles: { fillColor: [100, 100, 100], textColor: 255, fontStyle: 'bold' },
      head: [['Bezeichnung', 'Betrag €']],
      body: [
        ['Gesamtbetrag', k.gesamtbetrag.toFixed(2)],
        ['Anzahlung', k.anzahlung.toFixed(2)],
        ['Restbetrag', k.restbetrag.toFixed(2)]
      ],
      margin: { left: 20, right: 20 }
    });

    // Separate Seite für Kästchen + Unterschrift
    doc.addPage();
    addHeader();

    yPos = 90;
    doc.setFontSize(10);
    doc.setFont(undefined, "normal");

    function drawCheckbox(x, y) {
      doc.rect(x, y - 6, 6, 6);
    }

    doc.text("Der Kunde wurde über warentypische Eigenschaften des Polstermöbels aufgeklärt", 20, yPos);
    drawCheckbox(175, yPos);
    yPos += 16;

    doc.text("Hiermit werden die allgemeinen Geschäftsbedingungen akzeptiert", 20, yPos);
    drawCheckbox(175, yPos);
    yPos += 16;

    doc.text("Hiermit willige ich ein, aktuelle Newsletter und Werbung zu erhalten", 20, yPos);
    drawCheckbox(175, yPos);
    yPos += 30;

    doc.text(`Datum: ${today}`, 20, yPos);
    doc.text("Unterschrift Kunde:", 90, yPos);
    doc.line(90, yPos + 10, 180, yPos + 10);

    // AGB auf neuer Seite
    doc.addPage();

    doc.addImage(img, 'PNG', 170, 8, 30, 30);
    doc.setFontSize(16);
    doc.setFont(undefined, "bold");
    doc.text("Casa Divani", 20, 20);
    doc.setFontSize(14);
    doc.text("Allgemeine Geschäftsbedingungen (AGB)", 20, 40);
    doc.setFontSize(9.5);
    doc.setFont(undefined, "normal");

    const agbText = [
      "1. Geltungsbereich",
      "Diese Allgemeinen Geschäftsbedingungen gelten für alle Verträge über den Kauf von Waren in unserem Geschäft bzw. über unsere Website.",
      "",
      "2. Vertragsschluss",
      "Der Kaufvertrag kommt durch Übergabe der Ware und Zahlung des Kaufpreises bzw. durch Unterzeichnung des Kaufvertrags zustande.",
      "",
      "3. Preise und Zahlung",
      "Die angegebenen Preise sind Endpreise inkl. gesetzlicher Mehrwertsteuer. Zahlung erfolgt bar, per EC-/Kreditkarte oder per Überweisung. Bei Überweisung ist der Betrag innerhalb von 7 Tagen fällig.",
      "",
      "4. Eigentumsvorbehalt",
      "Die Ware bleibt bis zur vollständigen Bezahlung unser Eigentum.",
      "",
      "5. Lieferung und Montage",
      "Liefertermine sind unverbindlich, es sei denn, sie wurden ausdrücklich schriftlich als verbindlich vereinbart. Montageleistungen sind gesondert zu vergüten, sofern nicht anders vereinbart.",
      "",
      "6. Gewährleistung",
      "Es gelten die gesetzlichen Gewährleistungsregelungen. Offensichtliche Mängel sind unverzüglich, spätestens innerhalb von 14 Tagen nach Erhalt der Ware, zu rügen.",
      "",
      "7. Widerrufsrecht",
      "Bei Fernabsatzverträgen (z. B. Online-Bestellung) besteht ein gesetzliches Widerrufsrecht von 14 Tagen. Bei Maßanfertigungen oder individuell gefertigten Möbeln ist das Widerrufsrecht ausgeschlossen (§ 312g Abs. 2 Nr. 1 BGB).",
      "",
      "8. Datenschutz",
      "Ihre personenbezogenen Daten werden ausschließlich zur Abwicklung des Vertragsverhältnisses verwendet und gemäß DSGVO geschützt.",
      "",
      "9. Schlussbestimmungen",
      "Erfüllungsort und Gerichtsstand ist Musterstadt. Es gilt deutsches Recht. Sollten einzelne Bestimmungen unwirksam sein, bleibt die Wirksamkeit der übrigen Bestimmungen unberührt.",
      "",
      "Stand: Dezember 2025"
    ];

    doc.text(agbText, 20, 60, { lineHeightFactor: 1.4, maxWidth: 170 });

    yPos = 260;
    doc.setFontSize(10);
    doc.text(`Datum: ${today}`, 20, yPos);
    doc.text("Unterschrift Kunde:", 90, yPos);
    doc.line(90, yPos + 10, 180, yPos + 10);

    doc.save(`Kaufvertrag_${k.kaufvertragsnummer}.pdf`);
  };

  img.onerror = function () {
    alert("Logo konnte nicht geladen werden.");
    doc.save(`Kaufvertrag_${k.kaufvertragsnummer}.pdf`);
  };

  img.src = logoUrl;
}
  
function downloadHerstellerbestellungPDF(k) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.didDrawPage = function (data) {
    const pageHeight = doc.internal.pageSize.getHeight();
    doc.setFontSize(9);
    doc.setTextColor(100);
    const footerY = pageHeight - 15;
    doc.text("Folge uns: Instagram | TikTok | Facebook  |  #CasaDivani", 20, footerY);
    doc.text("www.casa-divani.de | info@casa-divani.de | Tel: 01234-567890", 20, footerY + 5);
  };

  doc.setFont("helvetica");

  const logoUrl = "https://i.imgur.com/o8Lowx7.png";
  const img = new Image();
  img.crossOrigin = "Anonymous";

  img.onload = function () {
    doc.addImage(img, 'PNG', 170, 8, 30, 30);

    doc.setFontSize(16);
    doc.setFont(undefined, "bold");
    doc.text("Casa Divani - Herstellerbestellung", 20, 20);

    doc.setFontSize(10);
    doc.setFont(undefined, "normal");
    doc.text("Musterstrasse 1, 11111 Musterstadt", 20, 28);
    doc.text("Telefon: 01234-567890 | E-Mail: info@casadivani.de", 20, 34);

    doc.setFontSize(12);
    doc.setFont(undefined, "bold");
    doc.text(`Kaufvertragsnummer: ${k.kaufvertragsnummer}`, 150, 20, { align: "right" });

    doc.setFontSize(11);
    doc.setFont(undefined, "normal");
    doc.text(`Kunde: ${k.kunde_vorname} ${k.kunde_nachname}`, 20, 44);
    doc.text(`Datum: ${k.datum}`, 20, 50);

    const artikelRows = k.artikel.map(a => [
      a.name,
      a.artikelnummer,
      a.beschreibung,
      '1'
    ]);

    doc.autoTable({
      head: [['Artikelname', 'Artikelnummer', 'Beschreibung', 'Menge']],
      body: artikelRows,
      startY: 60,
      styles: { fontSize: 10, cellPadding: 3 },
      headStyles: { fillColor: [100, 100, 100], textColor: 255, fontStyle: 'bold' },
      alternateRowStyles: { fillColor: [240, 240, 240] },
      margin: { left: 20, right: 20 }
    });

    doc.save(`Herstellerbestellung_${k.kaufvertragsnummer}.pdf`);
  };

  img.onerror = function () {
    alert("Logo konnte nicht geladen werden.");
  };

  img.src = logoUrl;
}

// Steuerbericht PDF
function downloadSteuerPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l', 'mm', 'a4');

  doc.setFontSize(14);
  doc.text("Casa Divani - Steuerbericht", 20, 20);
  doc.setFontSize(10);
  doc.text(`Datum: ${new Date().toLocaleDateString('de-DE')}`, 20, 28);

  const rows = [];
  let gesamtVK = 0, gesamtEK = 0, gesamtUSt = 0, gesamtVSt = 0, gesamtSteuer = 0;

  archiv.forEach(k => {
    k.artikel.forEach(a => {
      const ust = mwstAusBrutto(a.vk, a.steuer);
      const vst = mwstAusBrutto(a.ek, a.steuer);
      const steuer = ust - vst;

      gesamtVK += a.vk;
      gesamtEK += a.ek;
      gesamtUSt += ust;
      gesamtVSt += vst;
      gesamtSteuer += steuer;

      rows.push([
        k.kaufvertragsnummer,
        a.name,
        a.vk.toFixed(2),
        a.ek.toFixed(2),
        ust.toFixed(2),
        vst.toFixed(2),
        steuer.toFixed(2)
      ]);
    });
  });

  doc.autoTable({
    head: [['KV-Nr.', 'Artikel', 'VK brutto €', 'EK brutto €', 'USt €', 'VSt €', 'Steuerlast €']],
    body: rows,
    startY: 40,
    headStyles: { fillColor: [180, 180, 180] },
    styles: { fontSize: 9 },
    theme: 'grid'
  });

  const finalY = doc.lastAutoTable.finalY + 10;
  doc.setFontSize(11);
  doc.text(`Gesamt VK brutto: ${gesamtVK.toFixed(2)} €`, 20, finalY);
  doc.text(`Gesamt EK brutto: ${gesamtEK.toFixed(2)} €`, 20, finalY + 6);
  doc.text(`Gesamt USt: ${gesamtUSt.toFixed(2)} €`, 20, finalY + 12);
  doc.text(`Gesamt VSt: ${gesamtVSt.toFixed(2)} €`, 20, finalY + 18);
  doc.text(`Gesamt Steuerlast: ${gesamtSteuer.toFixed(2)} €`, 20, finalY + 24);

  doc.save('Steuerbericht.pdf');
}

// Preisschild PDF (DIN A6) – Listenpreis durchgestrichen (schräg, sauber durch Mitte)
function downloadPreisschildPDF(a) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
    orientation: 'portrait',
    unit: 'mm',
    format: [105, 148] // DIN A6 Hochformat
  });

  const logoUrl = "https://i.imgur.com/o8Lowx7.png";
  const img = new Image();
  img.crossOrigin = "Anonymous";

  img.onload = function () {
    // Logo rechts oben dezent
    doc.addImage(img, 'PNG', 105 - 25, 5, 20, 20);

    // Überschrift links oben
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text("Polstergarnitur", 10, 20);

    // Artikelname
    doc.setFontSize(18);
    doc.text(a.name, 10, 30);

    // Beschreibung
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    const beschreibungLines = doc.splitTextToSize(a.beschreibung || 'Keine Beschreibung', 85);
    doc.text(beschreibungLines, 10, 45);

    // Listenpreis berechnen (EK brutto / 1.19 * 4) – ganze Zahl
    const listenpreisNetto = a.ek / 1.19;
    const listenpreisBrutto = Math.round(listenpreisNetto * 4);
    const rabattProzent = Math.round(((listenpreisBrutto - a.vk) / listenpreisBrutto) * 100);

    // Listenpreis klein, grau
    const listenY = 95;
    doc.setFontSize(14);
    doc.setTextColor(100, 100, 100); // Grau
    const listenText = `Listenpreis: ${listenpreisBrutto} €`;
    doc.text(listenText, 52.5, listenY, { align: 'center' });

    // Schräge Durchstreich-Linie (höher angesetzt – perfekt durch Mitte)
    const textWidth = doc.getTextWidth(listenText);
    const lineStartX = 52.5 - textWidth / 2;
    const lineEndX = 52.5 + textWidth / 2;
    doc.setLineWidth(0.6);
    doc.line(lineStartX, listenY - 1, lineEndX, listenY + 1); // Schräg, höher angesetzt

    // "Sonderpreis bei Abholung" + Rabatt %
    doc.setTextColor(0, 0, 0); // Schwarz zurück
    doc.setFontSize(14);
    doc.text("Sonderpreis bei Abholung", 52.5, 110, { align: 'center' });
    doc.setFontSize(12);
    doc.setTextColor(200, 0, 0); // Rot für Rabatt
    doc.text(`-${rabattProzent}%`, 52.5, 118, { align: 'center' });

    // Sonderpreis groß
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(32);
    doc.setFont(undefined, 'bold');
    const preis = a.vk % 1 === 0 ? Math.round(a.vk) : a.vk.toFixed(2);
    doc.text(preis + ' €', 52.5, 130, { align: 'center' });

    doc.save(`Preisschild_${a.artikelnummer}.pdf`);
  };

  img.onerror = function () {
    alert("Logo konnte nicht geladen werden – Preisschild ohne Logo.");
    // Fallback ohne Logo (gleiches Layout)
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text("Polstergarnitur", 10, 20);
    doc.setFontSize(18);
    doc.text(a.name, 10, 30);
    doc.setFontSize(12);
    const beschreibungLines = doc.splitTextToSize(a.beschreibung || 'Keine Beschreibung', 85);
    doc.text(beschreibungLines, 10, 45);

    const listenpreisNetto = a.ek / 1.19;
    const listenpreisBrutto = Math.round(listenpreisNetto * 4);
    const rabattProzent = Math.round(((listenpreisBrutto - a.vk) / listenpreisBrutto) * 100);

    const listenY = 95;
    doc.setFontSize(14);
    doc.setTextColor(100, 100, 100);
    const listenText = `Listenpreis: ${listenpreisBrutto} €`;
    doc.text(listenText, 52.5, listenY, { align: 'center' });
    const textWidth = doc.getTextWidth(listenText);
    doc.setLineWidth(0.6);
    doc.line(52.5 - textWidth / 2, listenY - 1, 52.5 + textWidth / 2, listenY + 1); // Schräg, höher

    doc.setTextColor(0, 0, 0);
    doc.setFontSize(14);
    doc.text("Sonderpreis bei Abholung", 52.5, 110, { align: 'center' });
    doc.setFontSize(12);
    doc.setTextColor(200, 0, 0);
    doc.text(`-${rabattProzent}%`, 52.5, 118, { align: 'center' });

    doc.setTextColor(0, 0, 0);
    doc.setFontSize(32);
    doc.setFont(undefined, 'bold');
    const preis = a.vk % 1 === 0 ? Math.round(a.vk) : a.vk.toFixed(2);
    doc.text(preis + ' €', 52.5, 130, { align: 'center' });

    doc.save(`Preisschild_${a.artikelnummer}.pdf`);
  };

  img.src = logoUrl;
}

// Init beim Laden
window.onload = () => {
  supabaseClient.auth.getSession().then(({ data: { session } }) => {
    if (session) {
      document.getElementById('loginModal').style.display = 'none';
      initApp();
    }
  });
};

</script>

</body>
</html>



























