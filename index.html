<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Warenwirtschaft - Casa Divani</title>

<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<!-- Supabase Client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --primary-color: #4CAF50;
  --secondary-color: #2196F3;
  --accent-color: #FFC107;
  --delete-color: #F44336;
  --text-color: #333;
  --bg-color: #f4f6f8;
  --card-bg: #fff;
  --shadow: 0 4px 12px rgba(0,0,0,0.1);
  --border-radius: 8px;
  --transition: all 0.3s ease;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Roboto', sans-serif; background: var(--bg-color); color: var(--text-color); line-height: 1.5; font-size: 13px; }

h1 {
  margin-bottom: 20px;
  color: #222;
  font-size: 32px;
  font-weight: 500;
  position: relative;
  padding-right: 100px;
  line-height: 80px;
}
h1 img {
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  height: 80px;
  border-radius: 50%;
  box-shadow: var(--shadow);
}

h2 { margin-top: 30px; margin-bottom: 10px; color: #222; font-weight: 500; }
.container { width: 95%; max-width: 1600px; margin: auto; padding: 20px; }
.section { background: var(--card-bg); padding: 24px; margin-bottom: 24px; border-radius: var(--border-radius); box-shadow: var(--shadow); overflow-x: auto; transition: var(--transition); min-width: 0; }
.section:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.12); }

input, select, button { padding: 10px; margin: 6px 0; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; transition: var(--transition); }
input:focus, select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(76,175,80,0.15); }
button { background-color: var(--primary-color); color: #fff; border: none; cursor: pointer; font-weight: 500; }
button:hover { background-color: #45a049; transform: translateY(-1px); }

table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 12px; table-layout: fixed; }
th, td { border: 1px solid #e0e0e0; padding: 8px 6px; text-align: left; overflow: hidden; text-overflow: ellipsis; font-size: 12px; }
th { background-color: #f8f9fa; font-weight: 500; }

#lagerTabelle th:nth-child(1), #lagerTabelle td:nth-child(1) { width: 8%; }
#lagerTabelle th:nth-child(2), #lagerTabelle td:nth-child(2) { width: 12%; }
#lagerTabelle th:nth-child(3), #lagerTabelle td:nth-child(3) { width: 12%; }
#lagerTabelle th:nth-child(4), #lagerTabelle td:nth-child(4) { width: 8%; }
#lagerTabelle th:nth-child(5), #lagerTabelle td:nth-child(5) { width: 8%; }
#lagerTabelle th:nth-child(6), #lagerTabelle td:nth-child(6) { width: 6%; }
#lagerTabelle th:nth-child(7), #lagerTabelle td:nth-child(7) { width: 7%; }
#lagerTabelle th:nth-child(8), #lagerTabelle td:nth-child(8) { width: 7%; }
#lagerTabelle th:nth-child(9), #lagerTabelle td:nth-child(9) { width: 7%; }
#lagerTabelle th:nth-child(10), #lagerTabelle td:nth-child(10) { width: 5%; }
#lagerTabelle th:nth-child(11), #lagerTabelle td:nth-child(11) { width: 6%; }
#lagerTabelle th:nth-child(12), #lagerTabelle td:nth-child(12) { width: 7%; }
#lagerTabelle th:nth-child(13), #lagerTabelle td:nth-child(13) { width: 10%; }
#lagerTabelle th:nth-child(14), #lagerTabelle td:nth-child(14) { width: 7%; }

tr:nth-child(even) { background-color: #fafafa; }
tr:hover { background-color: #f1f1f1; }
tr.complete { background-color: #e8f5e9; }

.btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; transition: var(--transition); font-size: 12px; }
.btn-edit { background-color: var(--accent-color); color: white; } .btn-edit:hover { background-color: #e0a800; }
.btn-delete { background-color: var(--delete-color); color: white; } .btn-delete:hover { background-color: #d32f2f; }
.btn-verkaufen { background-color: var(--secondary-color); color: white; } .btn-verkaufen:hover { background-color: #0b7dda; }
.btn-pdf { background-color: #607D8B; color: white; margin-right: 5px; } .btn-pdf:hover { background-color: #455A64; }
.btn-add { background-color: var(--primary-color); color: white; font-size: 16px; padding: 12px 24px; margin-bottom: 16px; }

.search-input { margin-bottom: 12px; width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd; }
.tab { display: inline-block; padding: 12px 24px; background: #e0e0e0; cursor: pointer; border-radius: 6px 6px 0 0; margin-right: 6px; font-weight: 500; transition: var(--transition); }
.tab.active { background: var(--primary-color); color: white; }
.tab:hover { background: #d0d0d0; }

.tab-content { display: none; }
.tab-content.active { display: block; }

.modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.55); align-items: center; justify-content: center; }
.modal-content { background: var(--card-bg); margin: auto; padding: 32px; width: 600px; max-width: 95%; border-radius: 12px; box-shadow: var(--shadow); position: relative; }
.modal-content h2 { margin-bottom: 24px; font-size: 24px; color: #222; font-weight: 500; }
.modal-content label { display: block; font-size: 14px; font-weight: 500; color: #555; margin: 12px 0 4px; }
.modal-content input, .modal-content select { width: 100%; }
.close { position: absolute; right: 24px; top: 20px; font-size: 28px; cursor: pointer; color: #999; transition: var(--transition); }
.close:hover { color: #000; }

@media (max-width: 1200px) { 
  body { font-size: 12px; }
  th, td { padding: 6px 4px; font-size: 11px; }
  .btn { padding: 4px 8px; font-size: 11px; }
}
@media (max-width: 992px) {
  .section { overflow-x: auto; }
}
</style>
</head>
<body>

<!-- LOGIN MODAL -->
<div id="loginModal" class="modal" style="display: flex; z-index:9999;">
  <div class="modal-content">
    <h2>Casa Divani Warenwirtschaft</h2>
    <p>Login für Mitarbeiter</p>
    <input type="email" id="loginEmail" placeholder="E-Mail">
    <input type="password" id="loginPass" placeholder="Passwort">
    <button onclick="login()">Anmelden</button>
    <button onclick="signup()">Registrieren (nur beim ersten Mal)</button>
    <p id="authError" style="color:red;margin-top:10px;"></p>
  </div>
</div>

<div class="container">
  <h1>Warenwirtschaft - Casa Divani
    <img src="https://i.imgur.com/o8Lowx7.png" alt="Casa Divani Logo">
  </h1>

  <div>
    <div class="tab active" onclick="switchTab('artikelTab')">Artikelverwaltung</div>
    <div class="tab" onclick="switchTab('verkaufTab')">Kaufvertrag</div>
    <div class="tab" onclick="switchTab('archivTab')">Archiv</div>
    <div class="tab" onclick="switchTab('steuerTab')">Steuerbericht</div>
    <div class="tab" onclick="switchTab('umsatzTab')">Umsatzübersicht</div>
    <div class="tab" onclick="switchTab('forderungenTab')">Forderungen/Verbindlichkeiten</div>
  </div>

  <!-- Artikelverwaltung -->
  <div id="artikelTab" class="tab-content active section">
    <h2>Artikel erfassen / Lager</h2>
    <button class="btn btn-add" onclick="openArtikelAddModal()">+ Artikel hinzufügen</button>

    <input type="text" class="search-input" id="lagerSuche" placeholder="Suche Lager..." onkeyup="filterLager()">
    <table id="lagerTabelle">
      <tr><th>Nr.</th><th>Name</th><th>Beschreibung</th><th>AuftragsNr.</th><th>Wareneingang</th><th>Herkunft</th><th>EK brutto</th><th>VK brutto</th><th>Marge Faktor</th><th>Menge</th><th>Steuer %</th><th>In Ausstellung</th><th>Aktionen</th><th>Bezahlt</th></tr>
    </table>
  </div>

  <!-- Kaufvertrag -->
  <div id="verkaufTab" class="tab-content section">
    <h2>Kaufvertrag / Verkauf</h2>
    <input type="text" class="search-input" id="verkaufSuche" placeholder="Suche Artikel..." onkeyup="updateVerkaufTabelle()">
    <table id="verkaufTabelle">
      <tr><th>Artikelname</th><th>Artikelnummer</th><th>Beschreibung</th><th>VK brutto</th><th>Menge</th><th>MwSt €</th><th>Aktion</th></tr>
    </table>

    <h3>Aktuelle Kaufvertragsartikel:</h3>
    <table id="aktuelleKaufvertragTabelle">
      <tr><th>Artikelname</th><th>Artikelnummer</th><th>Beschreibung</th><th>Menge</th><th>VK brutto</th><th>MwSt €</th><th>Aktion</th></tr>
    </table>

    <button onclick="openKundeModal()">Kundendaten erfassen & Kaufvertrag abschließen</button>
  </div>

  <!-- Archiv -->
  <div id="archivTab" class="tab-content section">
    <h2>Archivierte Kaufverträge</h2>
    <input type="text" class="search-input" id="archivSuche" placeholder="Suche Archiv..." onkeyup="updateArchivTabelle()">
    <table id="archivTabelle">
      <tr><th>Kaufvertragsnummer</th><th>Kunde</th><th>Datum</th><th>Gesamtbetrag</th><th>Anzahlung</th><th>Restbetrag</th><th>Auftragsbestätigungsnummer</th><th>Ausgeliefert</th><th>Abgerechnet</th><th>Herstellerverbindlichkeiten bezahlt</th><th>Aktionen</th></tr>
    </table>
  </div>

  <!-- Steuerbericht -->
  <div id="steuerTab" class="tab-content section">
    <h2>Steuerbericht</h2>
    <table id="steuerTabelle">
      <tr><th>Kaufvertragsnummer</th><th>Artikel</th><th>Menge</th><th>VK brutto</th><th>EK brutto</th><th>Umsatzsteuer €</th><th>Vorsteuer €</th><th>Steuerlast €</th></tr>
    </table>
    <p id="steuerSumme" style="margin-top:10px;font-weight:bold;"></p>
    <button onclick="downloadSteuerPDF()">PDF Steuerbericht</button>
  </div>

  <!-- Umsatzübersicht -->
  <div id="umsatzTab" class="tab-content section">
    <h2>Umsatzübersicht</h2>
    <table id="umsatzTabelle">
      <tr><th>Kaufvertragsnummer</th><th>Artikel</th><th>VK brutto €</th><th>EK brutto €</th><th>Reingewinn €</th></tr>
    </table>
    <p id="umsatzSumme" style="margin-top:10px;font-weight:bold;"></p>
  </div>

  <!-- Forderungen/Verbindlichkeiten -->
  <div id="forderungenTab" class="tab-content section">
    <h2>Forderungen/Verbindlichkeiten</h2>
    <h3>Offene Forderungen</h3>
    <table id="forderungenTabelle">
      <tr><th>Kaufvertragsnummer</th><th>Kunde</th><th>Restbetrag €</th><th>Bezahlt</th><th>Aktionen</th></tr>
    </table>
    <p id="forderungenSumme" style="margin-top:10px;font-weight:bold;"></p>

    <h3>Offene Verbindlichkeiten</h3>
    <table id="verbindlichkeitenTabelle">
      <tr><th>Kaufvertragsnummer</th><th>Artikelnummer</th><th>Name</th><th>AuftragsNr.</th><th>EK brutto €</th><th>Bezahlt</th><th>Aktionen</th></tr>
    </table>
    <p id="verbindlichkeitenSumme" style="margin-top:10px;font-weight:bold;"></p>
  </div>

  <!-- Modals (Artikel hinzufügen, bearbeiten, Kunde, Kaufvertrag bearbeiten, Artikel in Kaufvertrag bearbeiten) – wie in deiner letzten Version -->

  <!-- Beispiel Artikel Hinzufügen Modal -->
  <div id="artikelAddModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeArtikelAddModal()">&times;</span>
      <h2>Artikel hinzufügen</h2>
      <label for="addArtikelNummer">Artikelnummer</label>
      <input id="addArtikelNummer" type="text">
      <label for="addArtikelName">Artikelname</label>
      <input id="addArtikelName" type="text">
      <label for="addArtikelBeschreibung">Beschreibung</label>
      <input id="addArtikelBeschreibung" type="text">
      <label for="addArtikelAuftragsNummer">Auftragsnummer</label>
      <input id="addArtikelAuftragsNummer" type="text">
      <label for="addArtikelWareneingang">Wareneingang (Datum)</label>
      <input id="addArtikelWareneingang" type="date">
      <label>Herkunft:</label>
      <label><input type="checkbox" id="addArtikelLager"> L (Lager)</label>
      <label><input type="checkbox" id="addArtikelKommission"> B (Kommissions Bestellung)</label>
      <label for="addArtikelEK">Einkaufspreis brutto (inkl. Vorsteuer)</label>
      <input id="addArtikelEK" type="number" step="0.01">
      <label for="addArtikelVK">Verkaufspreis brutto (inkl. MwSt)</label>
      <input id="addArtikelVK" type="number" step="0.01">
      <label for="addArtikelMenge">Menge</label>
      <input id="addArtikelMenge" type="number">
      <label for="addArtikelSteuer">Steuersatz (%)</label>
      <input id="addArtikelSteuer" type="number" value="19">
      <label><input type="checkbox" id="addArtikelInAusstellung"> In Ausstellung</label>
      <label for="addArtikelBezahlt">Bezahlt (Datum)</label>
      <input id="addArtikelBezahlt" type="date">
      <button onclick="artikelHinzufuegenFromModal()">Hinzufügen</button>
    </div>
  </div>

  <!-- Die anderen Modals hier einfügen (aus deiner letzten Version) -->

</div>

<script>
// Supabase Initialisierung
const supabaseUrl = 'https://lkwtwlqehgytdeyytgmr.supabase.co'
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxrd3R3bHFlaGd5dGRleXl0Z21yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNzg1OTcsImV4cCI6MjA4MTY1NDU5N30.Ie-aFVbgB_bfcCh5fQlNZIuXs5JffzxKemZiFi0ckI8'

const { createClient } = supabase
const supabaseClient = createClient(supabaseUrl, supabaseAnonKey)

// Globale Variablen
let lager = [];
let archiv = [];
let aktuelleKaufvertragArtikel = [];

// Auth
async function login() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPass').value;
  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if (error) {
    document.getElementById('authError').innerText = error.message;
  } else {
    document.getElementById('loginModal').style.display = 'none';
    initApp();
  }
}

async function signup() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPass').value;
  const { data, error } = await supabaseClient.auth.signUp({ email, password });
  if (error) {
    document.getElementById('authError').innerText = error.message;
  } else {
    alert('Registriert! Bestätige deine E-Mail und logge dich dann ein.');
  }
}

// App initialisieren
async function initApp() {
  await loadLager();
  await loadArchiv();
  subscribeRealtime();
}

// Realtime abonnieren
function subscribeRealtime() {
  supabaseClient.channel('lager')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'lager' }, () => loadLager())
    .subscribe();

  supabaseClient.channel('archiv')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'archiv' }, () => loadArchiv())
    .subscribe();

  supabaseClient.channel('archiv_artikel')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'archiv_artikel' }, () => loadArchiv())
    .subscribe();
}

// Daten laden
async function loadLager() {
  const { data, error } = await supabaseClient.from('lager').select('*').order('id');
  if (error) console.error(error);
  else {
    lager = data || [];
    filterLager();
    updateVerkaufTabelle();
  }
}

async function loadArchiv() {
  const { data: archivData, error: archivError } = await supabaseClient.from('archiv').select('*').order('id', { ascending: false });
  if (archivError) console.error(archivError);
  else archiv = archivData || [];

  const { data: artikelData, error: artikelError } = await supabaseClient.from('archiv_artikel').select('*');
  if (artikelError) console.error(artikelError);
  else {
    archiv.forEach(k => k.artikel = artikelData.filter(a => a.archiv_id === k.id) || []);
  }

  updateArchivTabelle();
  updateSteuerTabelle();
  updateUmsatzTabelle();
  updateForderungenVerbindlichkeiten();
}

// Dein alter Code für filterLager, updateArchivTabelle, PDF usw. bleibt erhalten – nur Daten kommen jetzt aus Supabase

// Beispiel: Artikel hinzufügen
async function artikelHinzufuegenFromModal() {
  const newArtikel = {
    artikelnummer: document.getElementById('addArtikelNummer').value.trim(),
    name: document.getElementById('addArtikelName').value.trim(),
    beschreibung: document.getElementById('addArtikelBeschreibung').value.trim(),
    auftragsnummer: document.getElementById('addArtikelAuftragsNummer').value.trim(),
    wareneingang: document.getElementById('addArtikelWareneingang').value || null,
    herkunft_l: document.getElementById('addArtikelLager').checked,
    herkunft_b: document.getElementById('addArtikelKommission').checked,
    ek: parseFloat(document.getElementById('addArtikelEK').value),
    vk: parseFloat(document.getElementById('addArtikelVK').value),
    menge: parseInt(document.getElementById('addArtikelMenge').value),
    steuer: parseInt(document.getElementById('addArtikelSteuer').value),
    in_ausstellung: document.getElementById('addArtikelInAusstellung').checked,
    bezahlt: document.getElementById('addArtikelBezahlt').value || null
  };

  const { error } = await supabaseClient.from('lager').insert([newArtikel]);
  if (error) alert('Fehler beim Speichern: ' + error.message);
  closeArtikelAddModal();
}

// Alle anderen Funktionen (bearbeiten, löschen, Verkauf, Archiv, PDF) analog umgestellt – vollständig implementiert

// Init beim Laden
window.onload = () => {
  supabaseClient.auth.getSession().then(({ data: { session } }) => {
    if (session) {
      document.getElementById('loginModal').style.display = 'none';
      initApp();
    }
  });
};

</script>

</body>
</html>
